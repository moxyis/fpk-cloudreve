name: ç‰ˆæœ¬æ¯”å¯¹åè‡ªåŠ¨æ‰“åŒ…å¤šæ¶æ„Cloudreve

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * *'  

# å…¨å±€è°ƒè¯•å¼€å…³ï¼štrue=è°ƒè¯•ï¼ˆç¦ç”¨æ¨é€ï¼‰ï¼Œfalse=ç”Ÿäº§
env:
  DEBUG_MODE: "false"

jobs:
  build-multi-arch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    steps:
      # ===================== ç¬¬ä¸€æ­¥ï¼šå…‹éš†ä»“åº“ & åˆå§‹åŒ–åŸºç¡€ç›®å½• =====================
      - name: 1. æ£€å‡ºå½“å‰ä»“åº“ï¼ˆå«CloudreveåŸºç¡€ç›®å½•ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. é…ç½®Gitèº«ä»½ï¼ˆè°ƒè¯•æ¨¡å¼ä»…æœ¬åœ°ç”Ÿæ•ˆï¼‰
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # è°ƒè¯•æ¨¡å¼ï¼šè¾“å‡ºä»“åº“ä¿¡æ¯
          if [ "$DEBUG_MODE" = "true" ]; then
            echo "===== è°ƒè¯•ï¼šå½“å‰ä»“åº“ç›®å½• ====="
            ls -lh
            echo "=============================="
          fi

      # ===================== æ–°å¢ï¼šè®¾ç½®ä¸­å›½æ—¶åŒºå¹¶è·å–æ ¼å¼åŒ–æ—¶é—´ =====================
      - name: 3. åˆå§‹åŒ–æ—¶åŒºå¹¶è·å–ä¸­å›½æ—¶åŒºæ‰“åŒ…æ—¶é—´
        id: build_time
        run: |
          # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·ï¼ˆUTC+8ï¼‰
          sudo timedatectl set-timezone Asia/Shanghai
          echo "âœ… å·²åˆ‡æ¢æ—¶åŒºä¸ºï¼šAsia/Shanghai"
          
          # è·å–æ ¼å¼åŒ–çš„ä¸­å›½æ—¶é—´ï¼ˆå¹´-æœˆ-æ—¥ æ—¶:åˆ†:ç§’ï¼‰
          BUILD_TIME=$(date "+%Y-%m-%d %H:%M:%S")
          echo "âœ… ä¸­å›½æ—¶åŒºæ‰“åŒ…æ—¶é—´ï¼š$BUILD_TIME"
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT

      # ===================== ç¬¬äºŒæ­¥ï¼šç‰ˆæœ¬æ¯”å¯¹ï¼ˆæ ¸å¿ƒå‰ç½®ï¼‰ =====================
      - name: 4. è¯»å–åŸºç¡€manifestçš„ç‰ˆæœ¬å·ï¼ˆç¡®ä¿åŸºç¡€ç›®å½•å®Œæ•´ï¼‰
        id: read_version
        run: |
          # åˆå§‹åŒ–åŸºç¡€Cloudreveç›®å½•åŠå­ç›®å½•ï¼ˆå…³é”®ä¿®å¤ï¼šç¡®ä¿app/binå­˜åœ¨ï¼‰
          mkdir -p Cloudreve/app/bin Cloudreve/app/conf
          MANIFEST_PATH="Cloudreve/manifest"
          
          # åˆå§‹åŒ–manifestæ–‡ä»¶ï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰
          if [ ! -f "$MANIFEST_PATH" ]; then
            echo "version: 0.0.0" > "$MANIFEST_PATH"
            echo "platform: x86" >> "$MANIFEST_PATH"
            git add "$MANIFEST_PATH"
            echo "âš ï¸ åˆå§‹åŒ–åŸºç¡€manifestæ–‡ä»¶ï¼Œç‰ˆæœ¬å·ï¼š0.0.0"
          fi

          # è¯»å–ç»Ÿä¸€çš„ç‰ˆæœ¬å·ï¼ˆå¿½ç•¥platformï¼‰
          LOCAL_VERSION=$(sed -n 's/^[[:space:]]*version[[:space:]]*[:=][[:space:]]*//p' "$MANIFEST_PATH" \
            | tr -d '"' | tr -d "'" | sed 's/^v//' | xargs)
          echo "æœ¬åœ°åŸºç¡€ç‰ˆæœ¬å·ï¼š$LOCAL_VERSION"
          echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT

      - name: 5. è·å–Cloudreveå®˜æ–¹æœ€æ–°ç‰ˆæœ¬å·
        id: remote_version
        run: |
          REMOTE_VERSION=$(curl -sSL --retry 3 --connect-timeout 10 \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/cloudreve/Cloudreve/releases/latest" \
            | jq -r '.tag_name' | sed 's/^v//' | xargs)
          
          if [ -z "$REMOTE_VERSION" ] || [ "$REMOTE_VERSION" = "null" ]; then
            echo "âŒ è·å–è¿œç¨‹ç‰ˆæœ¬å¤±è´¥"
            exit 1
          fi
          
          echo "å®˜æ–¹æœ€æ–°ç‰ˆæœ¬å·ï¼š$REMOTE_VERSION"
          echo "remote_version=$REMOTE_VERSION" >> $GITHUB_OUTPUT

      - name: 6. ç‰ˆæœ¬æ¯”å¯¹ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
        id: compare
        run: |
          if [ "${{ steps.read_version.outputs.local_version }}" = "${{ steps.remote_version.outputs.remote_version }}" ]; then
            echo "âœ… æœ¬åœ°ç‰ˆæœ¬ä¸å®˜æ–¹ä¸€è‡´ï¼ˆ${{ steps.remote_version.outputs.remote_version }}ï¼‰ï¼Œæ— éœ€æ‰“åŒ…"
            echo "need_update=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå¼€å§‹å¤šæ¶æ„æ‰“åŒ…æµç¨‹"
            echo "need_update=true" >> $GITHUB_OUTPUT
          fi

      # ===================== ç¬¬ä¸‰æ­¥ï¼šç‰ˆæœ¬ä¸ä¸€è‡´æ—¶æ‰§è¡Œå¤šæ¶æ„æ‰“åŒ… =====================
      - name: 7. å¤åˆ¶åŸºç¡€ç›®å½•å¹¶ä¿®æ”¹platformå­—æ®µï¼ˆç¡®ä¿å­ç›®å½•å®Œæ•´ï¼‰
        if: steps.compare.outputs.need_update == 'true'
        run: |
          # 1. å…ˆåˆ é™¤æ—§çš„æ¶æ„ç›®å½•ï¼ˆé¿å…æ®‹ç•™ï¼‰
          rm -rf Cloudreve-x86 Cloudreve-arm
          
          # 2. å¤åˆ¶åŸºç¡€Cloudreveç›®å½•ï¼ˆå«å®Œæ•´å­ç›®å½•ï¼‰
          cp -r Cloudreve Cloudreve-x86
          cp -r Cloudreve Cloudreve-arm
          
          # å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶åˆ›å»ºapp/binç›®å½•ï¼ˆé˜²æ­¢å¤åˆ¶é—æ¼ï¼‰
          mkdir -p Cloudreve-x86/app/bin Cloudreve-x86/app/conf
          mkdir -p Cloudreve-arm/app/bin Cloudreve-arm/app/conf
          echo "âœ… å¤åˆ¶åŸºç¡€ç›®å½•å¹¶ç¡®ä¿å­ç›®å½•å®Œæ•´ï¼šCloudreve-x86 / Cloudreve-arm"

          # 3. ä¿®æ”¹x86ç›®å½•çš„platformä¸ºx86ï¼Œæ›´æ–°ç‰ˆæœ¬å·
          sed -i -E \
            -e "s/(^[[:space:]]*platform[[:space:]]*[:=][[:space:]]*)([\"']?)(.+)([\"']?)/\1\2x86\4/" \
            -e "s/(^[[:space:]]*version[[:space:]]*[:=][[:space:]]*)([\"']?)(.+)([\"']?)/\1\2${{ steps.remote_version.outputs.remote_version }}\4/" \
            Cloudreve-x86/manifest
          
          # 4. ä¿®æ”¹armç›®å½•çš„platformä¸ºarmï¼Œæ›´æ–°ç‰ˆæœ¬å·
          sed -i -E \
            -e "s/(^[[:space:]]*platform[[:space:]]*[:=][[:space:]]*)([\"']?)(.+)([\"']?)/\1\2arm\4/" \
            -e "s/(^[[:space:]]*version[[:space:]]*[:=][[:space:]]*)([\"']?)(.+)([\"']?)/\1\2${{ steps.remote_version.outputs.remote_version }}\4/" \
            Cloudreve-arm/manifest
          
          # è°ƒè¯•æ¨¡å¼ï¼šè¾“å‡ºä¿®æ”¹åçš„manifestå’Œç›®å½•ç»“æ„
          if [ "$DEBUG_MODE" = "true" ]; then
            echo "===== è°ƒè¯•ï¼šx86 manifest ====="
            cat Cloudreve-x86/manifest
            echo "===== è°ƒè¯•ï¼šarm manifest ====="
            cat Cloudreve-arm/manifest
            echo "===== è°ƒè¯•ï¼šx86ç›®å½•ç»“æ„ ====="
            ls -lhR Cloudreve-x86/
            echo "=============================="
          fi

      - name: 8. ä¸‹è½½å¹¶å®‰è£…fnpackæ‰“åŒ…å·¥å…·
        if: steps.compare.outputs.need_update == 'true'
        run: |
          FNPACK_URL="https://static2.fnnas.com/fnpack/fnpack-1.2.0-linux-amd64"
          curl -SL --retry 3 --connect-timeout 10 -o /usr/local/bin/fnpack "$FNPACK_URL"
          chmod +x /usr/local/bin/fnpack
          
          if ! command -v fnpack &>/dev/null; then
            echo "âŒ fnpackå®‰è£…å¤±è´¥"
            exit 1
          fi
          echo "âœ… fnpackå®‰è£…å®Œæˆï¼š$(which fnpack)"

      - name: 9. æ‰¹é‡æ‰“åŒ…x86/armæ¶æ„ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šæ–‡ä»¶è·¯å¾„+æ ¡éªŒï¼‰
        if: steps.compare.outputs.need_update == 'true'
        id: build_packages
        run: |
          set -euo pipefail
          
          # å®šä¹‰æ¶æ„æ˜ å°„ï¼šç›®å½•å â†’ èµ„äº§åŒ¹é…å…³é”®è¯ â†’ æ‰“åŒ…æ–‡ä»¶å
          declare -A ARCH_CONFIG=(
            ["x86"]="linux_amd64.tar.gz"
            ["arm"]="linux_arm64.tar.gz"
          )
          
          # åˆ›å»ºäº§ç‰©ç›®å½•
          mkdir -p /tmp/cloudreve-packages
          # åˆå§‹åŒ–æ–‡ä»¶åˆ—è¡¨ï¼ˆç”¨æ¢è¡Œåˆ†éš”ï¼Œè€Œéç©ºæ ¼ï¼‰
          RELEASE_FILES=""

          # éå†æ¶æ„æ‰“åŒ…
          for ARCH in "${!ARCH_CONFIG[@]}"; do
            DIR_NAME="Cloudreve-$ARCH"
            ASSET_MATCH=${ARCH_CONFIG[$ARCH]}
            BIN_DIR="$DIR_NAME/app/bin"
            echo -e "\n========== å¼€å§‹æ‰“åŒ… $ARCH æ¶æ„ =========="

            # å…³é”®ä¿®å¤ï¼šå†æ¬¡æ ¡éªŒå¹¶åˆ›å»ºbinç›®å½•ï¼ˆåŒé‡ä¿éšœï¼‰
            mkdir -p "$BIN_DIR"
            echo "âœ… ç¡®ä¿ $ARCH äºŒè¿›åˆ¶ç›®å½•å­˜åœ¨ï¼š$BIN_DIR"

            # 1. è·å–å¯¹åº”æ¶æ„çš„ä¸‹è½½é“¾æ¥
            RELEASE_DATA=$(curl -sSL --retry 3 --connect-timeout 10 \
              "https://api.github.com/repos/cloudreve/Cloudreve/releases/latest")
            DOWNLOAD_URL=$(echo "$RELEASE_DATA" | jq -r \
              '.assets[] | select(.name | contains("'"$ASSET_MATCH"'")) | .browser_download_url' | head -n1)
            
            if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
              echo "âŒ æœªæ‰¾åˆ° $ARCH æ¶æ„çš„èµ„äº§ï¼ˆåŒ¹é…ï¼š$ASSET_MATCHï¼‰"
              continue
            fi
            echo "âœ… $ARCH ä¸‹è½½é“¾æ¥ï¼š$DOWNLOAD_URL"

            # 2. ä¸‹è½½å¹¶è§£å‹äºŒè¿›åˆ¶æ–‡ä»¶
            curl -SL --retry 3 --connect-timeout 10 -o /tmp/$ARCH.tar.gz "$DOWNLOAD_URL"
            tar -zxf /tmp/$ARCH.tar.gz -C /tmp
            if [ ! -f "/tmp/cloudreve" ]; then
              echo "âŒ $ARCH è§£å‹å¤±è´¥ï¼Œæœªæ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶"
              rm -f /tmp/$ARCH.tar.gz
              continue
            fi
            echo "âœ… $ARCH äºŒè¿›åˆ¶æ–‡ä»¶è§£å‹å®Œæˆ"

            # 3. æ›¿æ¢ç›®å½•å†…çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæ˜ç¡®æŒ‡å®šæ–‡ä»¶åï¼‰
            mv /tmp/cloudreve "$BIN_DIR/cloudreve"
            chmod +x "$BIN_DIR/cloudreve"
            rm -f /tmp/$ARCH.tar.gz /tmp/cloudreve
            echo "âœ… $ARCH äºŒè¿›åˆ¶æ–‡ä»¶å·²æ›¿æ¢åˆ°ï¼š$BIN_DIR/cloudreve"

            # 4. éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ ! -f "$BIN_DIR/cloudreve" ]; then
              echo "âŒ $ARCH äºŒè¿›åˆ¶æ–‡ä»¶æ›¿æ¢å¤±è´¥ï¼Œæ–‡ä»¶ä¸å­˜åœ¨"
              continue
            fi

            # 5. æ‰§è¡Œfnpackæ‰“åŒ…
            cd "$DIR_NAME"
            echo "ğŸš€ æ‰§è¡Œæ‰“åŒ…å‘½ä»¤ï¼šfnpack build"
            fnpack build
            cd -

            # 6. ç§»åŠ¨æ‰“åŒ…äº§ç‰©ï¼ˆæ ¡éªŒæ–‡ä»¶å­˜åœ¨æ€§ï¼‰
            FPK_FILE=$(find "$DIR_NAME" -name "*.fpk" -type f | head -n1)
            if [ -z "$FPK_FILE" ]; then
              echo "âŒ $ARCH æ‰“åŒ…å¤±è´¥ï¼Œæœªæ‰¾åˆ°fpkæ–‡ä»¶"
              continue
            fi
            # æ ¡éªŒFPKæ–‡ä»¶æ˜¯å¦çœŸçš„å­˜åœ¨
            if [ ! -f "$FPK_FILE" ]; then
              echo "âŒ $ARCH FPKæ–‡ä»¶è·¯å¾„æ— æ•ˆï¼š$FPK_FILE"
              continue
            fi
            
            FPK_NAME="fpk-cloudreve-$ARCH-v${{ steps.remote_version.outputs.remote_version }}.fpk"
            FPK_DEST="/tmp/cloudreve-packages/$FPK_NAME"
            mv "$FPK_FILE" "$FPK_DEST"
            
            # æ ¡éªŒç§»åŠ¨åçš„æ–‡ä»¶
            if [ ! -f "$FPK_DEST" ]; then
              echo "âŒ $ARCH FPKæ–‡ä»¶ç§»åŠ¨å¤±è´¥ï¼š$FPK_DEST"
              continue
            fi
            
            # å…³é”®ä¿®å¤ï¼šç”¨æ¢è¡Œåˆ†éš”æ–‡ä»¶è·¯å¾„ï¼ˆç¬¦åˆaction-gh-releaseè¦æ±‚ï¼‰
            RELEASE_FILES+="$FPK_DEST"$'\n'
            echo "âœ… $ARCH æ‰“åŒ…å®Œæˆï¼š$FPK_DEST"

            # è°ƒè¯•æ¨¡å¼ï¼šè¾“å‡ºæ–‡ä»¶è¯¦æƒ…
            if [ "$DEBUG_MODE" = "true" ]; then
              echo "===== è°ƒè¯•ï¼š$ARCH äº§ç‰©ä¿¡æ¯ ====="
              ls -lh "$FPK_DEST"
              sha256sum "$FPK_DEST"
              echo "=============================="
            fi
          done

          # æ¸…ç†ç©ºè¡Œï¼Œè¾“å‡ºäº§ç‰©åˆ—è¡¨
          RELEASE_FILES=$(echo "$RELEASE_FILES" | sed '/^$/d')
          echo -e "\nâœ… æ‰€æœ‰æ¶æ„æ‰“åŒ…å®Œæˆï¼Œäº§ç‰©åˆ—è¡¨ï¼š"
          echo "$RELEASE_FILES"
          ls -lh /tmp/cloudreve-packages/
          
          # ä¼ é€’äº§ç‰©è·¯å¾„ç»™åç»­æ­¥éª¤ï¼ˆä¿ç•™æ¢è¡Œæ ¼å¼ï¼‰
          echo "release_files<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "package_dir=/tmp/cloudreve-packages" >> $GITHUB_OUTPUT

      # ===================== ç¬¬å››æ­¥ï¼šè°ƒè¯•/ç”Ÿäº§æ¨¡å¼åˆ†æ”¯ =====================
      - name: 10. ç”Ÿäº§æ¨¡å¼ï¼šæ¨é€äº§ç‰©åˆ°FnDepotä»“åº“
        if: steps.compare.outputs.need_update == 'true' && env.DEBUG_MODE == 'false'
        run: |
          # å…‹éš†FnDepotä»“åº“
          git clone https://${{ secrets.FnDepot_PAT }}@github.com/moxyis/FnDepot.git /tmp/FnDepot
          
          # å¤åˆ¶äº§ç‰©åˆ°å¯¹åº”ç›®å½•
          mkdir -p /tmp/FnDepot/fpk-cloudreve/x86 /tmp/FnDepot/fpk-cloudreve/arm
          cp /tmp/cloudreve-packages/fpk-cloudreve-x86-* /tmp/FnDepot/fpk-cloudreve/x86/
          cp /tmp/cloudreve-packages/fpk-cloudreve-arm-* /tmp/FnDepot/fpk-cloudreve/arm/
          
          # æ›´æ–°ç‰ˆæœ¬é…ç½®
          cd /tmp/FnDepot
          # ç¡®ä¿fnpack.jsonå­˜åœ¨
          if [ ! -f "fnpack.json" ]; then
            echo '{"fpk-cloudreve": {"x86": {"version": ""}, "arm": {"version": ""}}}' > fnpack.json
          fi
          jq --arg ver "${{ steps.remote_version.outputs.remote_version }}" \
            '.["fpk-cloudreve"] = {"x86": {"version": $ver}, "arm": {"version": $ver}}' \
            fnpack.json > fnpack.tmp && mv fnpack.tmp fnpack.json
          
          # æäº¤å¹¶æ¨é€
          git add fpk-cloudreve/ fnpack.json
          git commit -m "chore: æ›´æ–°Cloudreveå¤šæ¶æ„ç‰ˆæœ¬è‡³${{ steps.remote_version.outputs.remote_version }}ï¼ˆæ‰“åŒ…æ—¶é—´ï¼š${{ steps.build_time.outputs.build_time }}ï¼‰" || echo "æ— å˜æ›´"
          git push origin main
          echo "âœ… äº§ç‰©å·²æ¨é€åˆ°FnDepotä»“åº“"

      - name: 11. è°ƒè¯•æ¨¡å¼ï¼šä»…è¾“å‡ºäº§ç‰©ä¿¡æ¯ï¼ˆç¦ç”¨æ¨é€ï¼‰
        if: steps.compare.outputs.need_update == 'true' && env.DEBUG_MODE == 'true'
        run: |
          echo -e "\nâš ï¸ è°ƒè¯•æ¨¡å¼ï¼šæ‰€æœ‰æ¨é€æ“ä½œå·²ç¦ç”¨"
          echo "===== æœ€ç»ˆäº§ç‰©æ¸…å• ====="
          ls -lh ${{ steps.build_packages.outputs.package_dir }}
          echo "========================"
          echo "âœ… è°ƒè¯•å®Œæˆï¼Œäº§ç‰©å­˜å‚¨è·¯å¾„ï¼š${{ steps.build_packages.outputs.package_dir }}"
          echo "âœ… ä¸­å›½æ—¶åŒºæ‰“åŒ…æ—¶é—´ï¼š${{ steps.build_time.outputs.build_time }}"

      - name: 12. ç”Ÿäº§æ¨¡å¼ï¼šåˆ›å»ºGitHub Releaseï¼ˆæ ¸å¿ƒä¿®å¤ï¼šå‚æ•°+æ–‡ä»¶è·¯å¾„+æ—¶åŒºæ—¶é—´ï¼‰
        if: steps.compare.outputs.need_update == 'true' && env.DEBUG_MODE == 'false'
        uses: softprops/action-gh-release@v2
        with:
          # ä¿®å¤ï¼šç§»é™¤åºŸå¼ƒçš„overwriteï¼Œä½¿ç”¨overwrite_files
          overwrite_files: true
          # Releaseæ ‡ç­¾
          tag_name: "cloudreve-v${{ steps.remote_version.outputs.remote_version }}"
          # Releaseæ ‡é¢˜
          name: "Cloudreve v${{ steps.remote_version.outputs.remote_version }}ï¼ˆå¤šæ¶æ„ï¼‰"
          # Releaseæè¿°ï¼ˆä½¿ç”¨ä¸­å›½æ—¶åŒºæ—¶é—´ï¼‰
          body: |
            ## Cloudreve å¤šæ¶æ„è‡ªåŠ¨æ‰“åŒ…
            - ç‰ˆæœ¬ï¼šv${{ steps.remote_version.outputs.remote_version }}
            - æ”¯æŒæ¶æ„ï¼šx86 / arm
            - æ‰“åŒ…æ—¶é—´ï¼š${{ steps.build_time.outputs.build_time }}
            - æ‰“åŒ…å·¥å…·ï¼šfnpack 1.2.0
          # å…³é”®ä¿®å¤ï¼šä½¿ç”¨æ¢è¡Œåˆ†éš”çš„æ–‡ä»¶è·¯å¾„ï¼ˆæ­£ç¡®ä¼ é€’ï¼‰
          files: ${{ steps.build_packages.outputs.release_files }}
          # å…¶ä»–å‚æ•°
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ===================== ç¬¬äº”æ­¥ï¼šæ›´æ–°åŸºç¡€manifestç‰ˆæœ¬å· =====================
      - name: 13. æ›´æ–°åŸºç¡€manifestç‰ˆæœ¬å·
        if: steps.compare.outputs.need_update == 'true'
        run: |
          # æ›´æ–°åŸºç¡€manifestçš„ç‰ˆæœ¬å·
          sed -i -E \
            "s/(^[[:space:]]*version[[:space:]]*[:=][[:space:]]*)([\"']?)(.+)([\"']?)/\1\2${{ steps.remote_version.outputs.remote_version }}\4/" \
            Cloudreve/manifest
          
          # ç”Ÿäº§æ¨¡å¼æ¨é€ï¼Œè°ƒè¯•æ¨¡å¼ä»…æš‚å­˜
          git add Cloudreve/manifest
          if [ "$DEBUG_MODE" = "false" ]; then
            git commit -m "chore: æ›´æ–°åŸºç¡€ç‰ˆæœ¬å·è‡³${{ steps.remote_version.outputs.remote_version }}ï¼ˆæ‰“åŒ…æ—¶é—´ï¼š${{ steps.build_time.outputs.build_time }}ï¼‰"
            git push origin HEAD:${{ github.ref_name }}
            echo "âœ… åŸºç¡€manifestç‰ˆæœ¬å·å·²æ¨é€"
          else
            echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šåŸºç¡€manifestå·²æ›´æ–°ï¼Œä»…æœ¬åœ°æš‚å­˜æœªæ¨é€"
            echo "âœ… ä¸­å›½æ—¶åŒºæ‰“åŒ…æ—¶é—´ï¼š${{ steps.build_time.outputs.build_time }}"
          fi
