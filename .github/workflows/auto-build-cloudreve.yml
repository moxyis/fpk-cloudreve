name: ç‰ˆæœ¬æ¯”å¯¹åè‡ªåŠ¨æ‰“åŒ…Cloudreve

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥UTC 0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰è‡ªåŠ¨æ£€æµ‹

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      # ===================== ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡ =====================
      - name: 1. æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: 2. å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆjq/curl/sedï¼‰
        run: |
          sudo apt update && sudo apt install -y jq curl sed
          echo "åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆ"

      # ===================== ç¬¬äºŒæ­¥ï¼šç‰ˆæœ¬æ¯”å¯¹ï¼ˆæ ¸å¿ƒå‰ç½®ï¼‰ =====================
      - name: 3. è¯»å–æœ¬åœ°manifestç‰ˆæœ¬å·
        id: local_ver
        run: |
          if [ -f "cloudreve/manifest" ]; then
            # æå–versionå­—æ®µï¼ˆå…¼å®¹å¤šæ ¼å¼ï¼Œå»é™¤vå‰ç¼€/å¼•å·ï¼‰
            LOCAL_VERSION=$(sed -n 's/^[[:space:]]*version[[:space:]]*[:=][[:space:]]*//p' cloudreve/manifest \
              | tr -d '"' | tr -d "'" | sed 's/^v//' | xargs)
            echo "æœ¬åœ°manifestç‰ˆæœ¬ï¼š$LOCAL_VERSION"
            echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT
          else
            echo "âŒ æœªæ‰¾åˆ°cloudreve/manifestï¼Œå¼ºåˆ¶è§¦å‘æ›´æ–°"
            echo "local_version=0.0.0" >> $GITHUB_OUTPUT
          fi

      - name: 4. è·å–Cloudreveå®˜æ–¹æœ€æ–°æ­£å¼ç‰ˆç‰ˆæœ¬å·
        id: remote_ver
        run: |
          # ä»…è·å–ç‰ˆæœ¬å·ï¼ˆè½»é‡è¯·æ±‚ï¼Œæ·»åŠ é‡è¯•/è¶…æ—¶ï¼‰
          REMOTE_VERSION=$(curl -sSL --retry 3 --connect-timeout 10 \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/cloudreve/Cloudreve/releases/latest" \
            | jq -r '.tag_name' | sed 's/^v//' | xargs)
          
          if [ -z "$REMOTE_VERSION" ] || [ "$REMOTE_VERSION" = "null" ]; then
            echo "âŒ è·å–è¿œç¨‹ç‰ˆæœ¬å¤±è´¥"
            exit 1
          fi
          
          echo "è¿œç¨‹æœ€æ–°ç‰ˆæœ¬ï¼š$REMOTE_VERSION"
          echo "remote_version=$REMOTE_VERSION" >> $GITHUB_OUTPUT

      - name: 5. ç‰ˆæœ¬æ¯”å¯¹ï¼Œåˆ¤æ–­æ˜¯å¦æ›´æ–°
        id: compare
        run: |
          if [ "${{ steps.local_ver.outputs.local_version }}" = "${{ steps.remote_ver.outputs.remote_version }}" ]; then
            echo "âœ… æœ¬åœ°ç‰ˆæœ¬ä¸è¿œç¨‹ç‰ˆæœ¬ä¸€è‡´ï¼ˆ${{ steps.remote_ver.outputs.remote_version }}ï¼‰ï¼Œæ— éœ€æ›´æ–°"
            echo "need_update=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå¼€å§‹æ›´æ–°æ‰“åŒ…æµç¨‹"
            echo "need_update=true" >> $GITHUB_OUTPUT
          fi

      # ===================== ç¬¬ä¸‰æ­¥ï¼šä»…ç‰ˆæœ¬ä¸ä¸€è‡´æ—¶æ‰§è¡Œ =====================
      - name: 6. ä¸‹è½½Cloudreveï¼ˆé€‚é…é€šç”¨å‘½åè§„åˆ™ï¼šcloudreve_ç‰ˆæœ¬å·_ç³»ç»Ÿ_æ¶æ„.tar.gzï¼‰
        if: steps.compare.outputs.need_update == 'true'
        id: download_cloudreve
        run: |
          set -euo pipefail
          
          # å®šä¹‰ç›®æ ‡ç³»ç»Ÿ/æ¶æ„ï¼ˆå¯æŒ‰éœ€ä¿®æ”¹ï¼‰
          TARGET_OS="linux"
          TARGET_ARCH="amd64"
          
          # 1. è·å–å®Œæ•´å‘è¡Œç‰ˆæ•°æ®
          RELEASE_DATA=$(curl -sSL --retry 3 --connect-timeout 10 \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/cloudreve/Cloudreve/releases/latest")
          
          # 2. è°ƒè¯•ï¼šè¾“å‡ºæ‰€æœ‰èµ„äº§åç§°ï¼Œç¡®è®¤å‘½åè§„åˆ™
          echo "ğŸ“œ è¿œç¨‹å‘è¡Œç‰ˆæ‰€æœ‰èµ„äº§åç§°ï¼š"
          ASSET_NAMES=$(echo "$RELEASE_DATA" | jq -r '.assets[].name')
          echo "$ASSET_NAMES"
          
          # 3. é€šç”¨åŒ¹é…è§„åˆ™ï¼šcloudreve_ä»»æ„ç‰ˆæœ¬å·_ç›®æ ‡ç³»ç»Ÿ_ç›®æ ‡æ¶æ„.tar.gz
          # æ­£åˆ™è§£æï¼š^cloudreve_([^_]+)_(ç›®æ ‡ç³»ç»Ÿ)_(ç›®æ ‡æ¶æ„)\.tar\.gz$
          DOWNLOAD_URL=$(echo "$RELEASE_DATA" | jq -r --arg os "$TARGET_OS" --arg arch "$TARGET_ARCH" \
            '.assets[] | select(.name | test("^cloudreve_[^_]+_" + $os + "_" + $arch + "\\.tar\\.gz$"; "i")) | .browser_download_url' | head -n1)
          
          # 4. æœ€ç»ˆæ ¡éªŒ
          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
            echo "âŒ æœªæ‰¾åˆ°ç¬¦åˆè§„åˆ™çš„èµ„äº§ï¼šcloudreve_ç‰ˆæœ¬å·_${TARGET_OS}_${TARGET_ARCH}.tar.gz"
            exit 1
          fi
          
          # 5. æå–åŒ¹é…åˆ°çš„èµ„äº§åï¼ˆä¾¿äºæ—¥å¿—å±•ç¤ºï¼‰
          MATCHED_ASSET=$(echo "$ASSET_NAMES" | grep -i "^cloudreve_[^_]+_${TARGET_OS}_${TARGET_ARCH}\.tar\.gz$" | head -n1)
          echo "âœ… åŒ¹é…åˆ°ç›®æ ‡èµ„äº§ï¼š$MATCHED_ASSET"
          echo "âœ… ä¸‹è½½é“¾æ¥ï¼š$DOWNLOAD_URL"
          
          # 6. åˆ›å»ºç›®å½•å¹¶ä¸‹è½½è§£å‹
          mkdir -p cloudreve/app/bin
          curl -SL --retry 3 --connect-timeout 10 -o /tmp/cloudreve.tar.gz "$DOWNLOAD_URL"
          
          # 7. è§£å‹å¹¶éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆCloudreveè§£å‹åç›´æ¥æ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼‰
          tar -zxf /tmp/cloudreve.tar.gz -C /tmp
          if [ ! -f "/tmp/cloudreve" ]; then
            echo "âŒ è§£å‹åæœªæ‰¾åˆ°cloudreveäºŒè¿›åˆ¶æ–‡ä»¶"
            exit 1
          fi
          
          # 8. ç§»åŠ¨æ–‡ä»¶+æ·»åŠ æ‰§è¡Œæƒé™
          mv /tmp/cloudreve cloudreve/app/bin/
          chmod +x cloudreve/app/bin/cloudreve
          rm -rf /tmp/cloudreve.tar.gz /tmp/cloudreve
          
          # 9. éªŒè¯æ–‡ä»¶ï¼ˆç¡®ä¿æ˜¯Linux AMD64å¯æ‰§è¡Œæ–‡ä»¶ï¼‰
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶ä¿¡æ¯ï¼š"
          ls -lh cloudreve/app/bin/cloudreve
          file cloudreve/app/bin/cloudreve | grep -q "x86-64" || echo "âš ï¸ æ³¨æ„ï¼šæ–‡ä»¶å¯èƒ½ä¸æ˜¯AMD64æ¶æ„"

      - name: 7. æ›´æ–°manifestçš„versionå­—æ®µ
        if: steps.compare.outputs.need_update == 'true'
        run: |
          # å…¼å®¹å¤šæ ¼å¼æ›´æ–°versionï¼ˆYAML/JSON/é”®å€¼å¯¹ï¼‰
          sed -i -E \
            "s/(^[[:space:]]*version[[:space:]]*[:=][[:space:]]*)([\"']?)([0-9a-zA-Z.]+)([\"']?)/\1\2${{ steps.remote_ver.outputs.remote_version }}\4/" \
            cloudreve/manifest
          
          echo "âœ… manifestç‰ˆæœ¬å·²æ›´æ–°ä¸ºï¼š${{ steps.remote_ver.outputs.remote_version }}"
          cat cloudreve/manifest | grep -i version

      - name: 8. ä¸‹è½½å¹¶å®‰è£…fnpackï¼ˆæŒ‡å®šåœ°å€ï¼‰
        if: steps.compare.outputs.need_update == 'true'
        run: |
          # ä¸‹è½½fnpack-1.0.4-linux-amd64
          FNPACK_URL="https://static2.fnnas.com/fnpack/fnpack-1.0.4-linux-amd64"
          curl -SL --retry 3 --connect-timeout 10 -o /usr/local/bin/fnpack "$FNPACK_URL"
          chmod +x /usr/local/bin/fnpack
          
          # éªŒè¯å®‰è£…
          if ! command -v fnpack &>/dev/null; then
            echo "âŒ fnpackå®‰è£…å¤±è´¥"
            exit 1
          fi
          echo "âœ… fnpackå®‰è£…å®Œæˆï¼š$(which fnpack)"

      - name: 9. æ‰§è¡Œfnpackæ‰“åŒ…
        if: steps.compare.outputs.need_update == 'true'
        run: |
          cd cloudreve
          echo "ğŸ“‹ æ‰“åŒ…ç›®å½•ç»“æ„ï¼š"
          ls -lh app/bin/
          echo "ğŸš€ æ‰§è¡Œæ‰“åŒ…å‘½ä»¤ï¼šfnpack build --directory app"
          fnpack build --directory app
          echo "âœ… fnpackæ‰“åŒ…å®Œæˆ"

      # ===================== å¯é€‰ï¼šä¸Šä¼ æ‰“åŒ…äº§ç‰© =====================
      - name: 10. ä¸Šä¼ æ‰“åŒ…äº§ç‰©
        if: steps.compare.outputs.need_update == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: cloudreve-build-${{ steps.remote_ver.outputs.remote_version }}
          path: cloudreve/
          retention-days: 7
