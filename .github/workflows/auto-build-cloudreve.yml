name: ç‰ˆæœ¬æ¯”å¯¹åè‡ªåŠ¨æ‰“åŒ…Cloudreveå¹¶æ›´æ–°ä»“åº“

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * *'  

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æˆäºˆå†™å…¥ä»“åº“/åˆ›å»ºReleaseæƒé™
      pull-requests: read
    steps:
      # ===================== ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡ =====================
      - name: 1. æ£€å‡ºå½“å‰ä»“åº“ä»£ç ï¼ˆå¸¦å®Œæ•´å†å²ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´æ£€å‡ºå†å²
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. é…ç½®Gitå…¨å±€èº«ä»½ï¼ˆè·¨ä»“åº“æ¨é€é€šç”¨ï¼‰
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: 3. å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆjq/curl/sedï¼‰
        run: |
          sudo apt update && sudo apt install -y jq curl sed
          echo "åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆ"

      # ===================== ç¬¬äºŒæ­¥ï¼šç‰ˆæœ¬æ¯”å¯¹ï¼ˆæ ¸å¿ƒå‰ç½®ï¼‰ =====================
      - name: 4. è¯»å–æœ¬åœ°manifestç‰ˆæœ¬å·
        id: local_ver
        run: |
          if [ -f "Cloudreve/manifest" ]; then
            LOCAL_VERSION=$(sed -n 's/^[[:space:]]*version[[:space:]]*[:=][[:space:]]*//p' Cloudreve/manifest \
              | tr -d '"' | tr -d "'" | sed 's/^v//' | xargs)
            echo "æœ¬åœ°manifestç‰ˆæœ¬ï¼š$LOCAL_VERSION"
            echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT
          else
            echo "âŒ æœªæ‰¾åˆ°Cloudreve/manifestï¼Œå¼ºåˆ¶è§¦å‘æ›´æ–°"
            echo "local_version=0.0.0" >> $GITHUB_OUTPUT
            mkdir -p Cloudreve
            echo "version: 0.0.0" > Cloudreve/manifest
            git add Cloudreve/manifest
            git commit -m "chore: åˆå§‹åŒ–manifestæ–‡ä»¶" || echo "æ— éœ€è¦æäº¤çš„å˜æ›´"
          fi

      - name: 5. è·å–Cloudreveå®˜æ–¹æœ€æ–°æ­£å¼ç‰ˆç‰ˆæœ¬å·
        id: remote_ver
        run: |
          REMOTE_VERSION=$(curl -sSL --retry 3 --connect-timeout 10 \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/cloudreve/Cloudreve/releases/latest" \
            | jq -r '.tag_name' | sed 's/^v//' | xargs)
          
          if [ -z "$REMOTE_VERSION" ] || [ "$REMOTE_VERSION" = "null" ]; then
            echo "âŒ è·å–è¿œç¨‹ç‰ˆæœ¬å¤±è´¥"
            exit 1
          fi
          
          echo "è¿œç¨‹æœ€æ–°ç‰ˆæœ¬ï¼š$REMOTE_VERSION"
          echo "remote_version=$REMOTE_VERSION" >> $GITHUB_OUTPUT

      - name: 6. ç‰ˆæœ¬æ¯”å¯¹ï¼Œåˆ¤æ–­æ˜¯å¦æ›´æ–°
        id: compare
        run: |
          if [ "${{ steps.local_ver.outputs.local_version }}" = "${{ steps.remote_ver.outputs.remote_version }}" ]; then
            echo "âœ… æœ¬åœ°ç‰ˆæœ¬ä¸è¿œç¨‹ç‰ˆæœ¬ä¸€è‡´ï¼ˆ${{ steps.remote_ver.outputs.remote_version }}ï¼‰ï¼Œæ— éœ€æ›´æ–°"
            echo "need_update=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå¼€å§‹æ›´æ–°æ‰“åŒ…æµç¨‹"
            echo "need_update=true" >> $GITHUB_OUTPUT
          fi

      # ===================== ç¬¬ä¸‰æ­¥ï¼šä»…ç‰ˆæœ¬ä¸ä¸€è‡´æ—¶æ‰§è¡Œ =====================
      - name: 7. ä¸‹è½½Cloudreve Linux AMD64ç‰ˆæœ¬ï¼ˆæç®€åŒ¹é…ï¼‰
        if: steps.compare.outputs.need_update == 'true'
        id: download_cloudreve
        run: |
          set -euo pipefail
          
          # 1. è·å–å®Œæ•´å‘è¡Œç‰ˆæ•°æ®
          RELEASE_DATA=$(curl -sSL --retry 3 --connect-timeout 10 \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/cloudreve/Cloudreve/releases/latest")
          
          # 2. è°ƒè¯•ï¼šè¾“å‡ºæ‰€æœ‰èµ„äº§åç§°
          echo "ğŸ“œ è¿œç¨‹å‘è¡Œç‰ˆæ‰€æœ‰èµ„äº§åç§°ï¼š"
          echo "$RELEASE_DATA" | jq -r '.assets[].name'
          
          # 3. æç®€åŒ¹é…ï¼šç›´æ¥ç­›é€‰åŒ…å« "linux_amd64.tar.gz" çš„èµ„äº§
          DOWNLOAD_URL=$(echo "$RELEASE_DATA" | jq -r \
            '.assets[] | select(.name | contains("linux_amd64.tar.gz")) | .browser_download_url' | head -n1)
          
          # 4. æœ€ç»ˆæ ¡éªŒ
          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
            echo "âŒ æœªæ‰¾åˆ°åŒ…å« 'linux_amd64.tar.gz' çš„èµ„äº§"
            exit 1
          fi
          
          # 5. æå–åŒ¹é…åˆ°çš„èµ„äº§å
          MATCHED_ASSET=$(echo "$RELEASE_DATA" | jq -r '.assets[] | select(.name | contains("linux_amd64.tar.gz")) | .name' | head -n1)
          echo "âœ… åŒ¹é…åˆ°ç›®æ ‡èµ„äº§ï¼š$MATCHED_ASSET"
          echo "âœ… ä¸‹è½½é“¾æ¥ï¼š$DOWNLOAD_URL"
          
          # 6. åˆ›å»ºç›®å½•å¹¶ä¸‹è½½
          mkdir -p Cloudreve/app/bin
          curl -SL --retry 3 --connect-timeout 10 -o /tmp/cloudreve.tar.gz "$DOWNLOAD_URL"
          
          # 7. è§£å‹å¹¶éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶
          tar -zxf /tmp/cloudreve.tar.gz -C /tmp
          if [ ! -f "/tmp/cloudreve" ]; then
            echo "âŒ è§£å‹åæœªæ‰¾åˆ°cloudreveäºŒè¿›åˆ¶æ–‡ä»¶"
            exit 1
          fi
          
          # 8. ç§»åŠ¨æ–‡ä»¶+æ·»åŠ æ‰§è¡Œæƒé™
          mv /tmp/cloudreve Cloudreve/app/bin/
          chmod +x Cloudreve/app/bin/cloudreve
          rm -rf /tmp/cloudreve.tar.gz /tmp/cloudreve
          
          # 9. éªŒè¯æ–‡ä»¶ä¿¡æ¯
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶ä¿¡æ¯ï¼š"
          ls -lh Cloudreve/app/bin/cloudreve
          file Cloudreve/app/bin/cloudreve

      - name: 8. æ›´æ–°manifestçš„versionå­—æ®µ
        if: steps.compare.outputs.need_update == 'true'
        run: |
          # æ›´æ–°ç‰ˆæœ¬å·
          sed -i -E \
            "s/(^[[:space:]]*version[[:space:]]*[:=][[:space:]]*)([\"']?)([0-9a-zA-Z.]+)([\"']?)/\1\2${{ steps.remote_ver.outputs.remote_version }}\4/" \
            Cloudreve/manifest
          
          echo "âœ… manifestç‰ˆæœ¬å·²æ›´æ–°ä¸ºï¼š${{ steps.remote_ver.outputs.remote_version }}"
          cat Cloudreve/manifest | grep -i version

          # æš‚å­˜å˜æ›´
          git add Cloudreve/manifest

      - name: 9. æäº¤å¹¶æ¨é€manifestå˜æ›´åˆ°å½“å‰ä»“åº“
        if: steps.compare.outputs.need_update == 'true'
        run: |
          git commit -m "chore: æ›´æ–°Cloudreveç‰ˆæœ¬è‡³${{ steps.remote_ver.outputs.remote_version }}" || echo "âœ… æ— éœ€è¦æäº¤çš„manifestå˜æ›´"
          git push origin HEAD:${{ github.ref_name }}
          echo "âœ… manifestç‰ˆæœ¬å·å·²æ¨é€åˆ°å½“å‰ä»“åº“"

      - name: 10. ä¸‹è½½å¹¶å®‰è£…fnpackï¼ˆæŒ‡å®šåœ°å€ï¼‰
        if: steps.compare.outputs.need_update == 'true'
        run: |
          FNPACK_URL="https://static2.fnnas.com/fnpack/fnpack-1.0.4-linux-amd64"
          curl -SL --retry 3 --connect-timeout 10 -o /usr/local/bin/fnpack "$FNPACK_URL"
          chmod +x /usr/local/bin/fnpack
          
          if ! command -v fnpack &>/dev/null; then
            echo "âŒ fnpackå®‰è£…å¤±è´¥"
            exit 1
          fi
          echo "âœ… fnpackå®‰è£…å®Œæˆï¼š$(which fnpack)"

      - name: 11. è¿›å…¥Cloudreveç›®å½•æ‰§è¡Œfnpackæ‰“åŒ…ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼‰
        if: steps.compare.outputs.need_update == 'true'
        id: build_fpk
        run: |
          # è¿›å…¥Cloudreveç›®å½•
          cd Cloudreve
          echo "ğŸš€ è¿›å…¥Cloudreveç›®å½•ï¼Œæ‰§è¡Œæ‰“åŒ…å‘½ä»¤ï¼šfnpack build"
          fnpack build
          
          # æŸ¥æ‰¾æ‰“åŒ…åçš„fpkæ–‡ä»¶ï¼ˆå½“å‰ç›®å½•å³Cloudreveï¼‰
          FPK_FILE=$(find . -name "*.fpk" -type f | head -n1)
          if [ -z "$FPK_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ°æ‰“åŒ…åçš„fpkæ–‡ä»¶"
            exit 1
          fi
          
          # æ‹¼æ¥å®Œæ•´è·¯å¾„ï¼ˆä¾¿äºåç»­å¤åˆ¶ï¼‰
          FPK_FULL_PATH=$(pwd)/$FPK_FILE
          # ä¿ç•™å›ºå®šåç§°ç”¨äºæ¨é€FnDepot
          FPK_FIXED_NAME="fpk-cloudreve.fpk"
          # æ–°å¢å¸¦ç‰ˆæœ¬å·çš„åç§°ç”¨äºReleaseä¸Šä¼ 
          FPK_VERSION_NAME="fpk-cloudreve-v${{ steps.remote_ver.outputs.remote_version }}.fpk"
          
          # å¤åˆ¶ä¸¤ä»½ï¼šä¸€ä»½å›ºå®šåç§°æ¨FnDepotï¼Œä¸€ä»½å¸¦ç‰ˆæœ¬å·ä¼ Release
          mv "$FPK_FULL_PATH" /tmp/$FPK_FIXED_NAME
          cp /tmp/$FPK_FIXED_NAME /tmp/$FPK_VERSION_NAME
          
          echo "âœ… fnpackæ‰“åŒ…å®Œæˆï¼š"
          echo "  - å›ºå®šåç§°ï¼š/tmp/$FPK_FIXED_NAME"
          echo "  - ç‰ˆæœ¬åç§°ï¼š/tmp/$FPK_VERSION_NAME"
          echo "fpk_file=/tmp/$FPK_FIXED_NAME" >> $GITHUB_OUTPUT
          echo "fpk_name=$FPK_FIXED_NAME" >> $GITHUB_OUTPUT
          echo "fpk_release_file=/tmp/$FPK_VERSION_NAME" >> $GITHUB_OUTPUT
          echo "fpk_release_name=$FPK_VERSION_NAME" >> $GITHUB_OUTPUT

      # ===================== ç¬¬å››æ­¥ï¼šæ¨é€fpkåˆ°FnDepotä»“åº“ + æ›´æ–°fnpack.json + æ›´æ–°README.md =====================
      - name: 12. å…‹éš†FnDepotä»“åº“ï¼ˆç›®æ ‡ä»“åº“ï¼‰
        if: steps.compare.outputs.need_update == 'true'
        run: |
          # ä½¿ç”¨PATä»¤ç‰Œå…‹éš†ï¼ˆéœ€åœ¨å½“å‰ä»“åº“Secretsé…ç½® FnDepot_PATï¼‰
          git clone https://${{ secrets.FnDepot_PAT }}@github.com/moxyis/FnDepot.git /tmp/FnDepot
          echo "âœ… æˆåŠŸå…‹éš†FnDepotä»“åº“åˆ°/tmp/FnDepot"

      - name: 13. å¤åˆ¶fpkæ–‡ä»¶åˆ°FnDepotä»“åº“ç›®æ ‡ç›®å½•ï¼ˆè¦†ç›–æ—§æ–‡ä»¶ï¼‰
        if: steps.compare.outputs.need_update == 'true'
        run: |
          # åˆ›å»ºç›®æ ‡æ–‡ä»¶å¤¹ï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰
          mkdir -p /tmp/FnDepot/fpk-cloudreve
          
          # å…ˆåˆ é™¤æ—§çš„fpkæ–‡ä»¶ï¼ˆé¿å…å†—ä½™ï¼‰
          rm -f /tmp/FnDepot/fpk-cloudreve/fpk-cloudreve.fpk
          
          # å¤åˆ¶æ–°çš„fpkæ–‡ä»¶ï¼ˆå›ºå®šåç§°ï¼‰
          cp ${{ steps.build_fpk.outputs.fpk_file }} /tmp/FnDepot/fpk-cloudreve/
          
          echo "âœ… fpkæ–‡ä»¶å·²å¤åˆ¶åˆ°ï¼š/tmp/FnDepot/fpk-cloudreve/${{ steps.build_fpk.outputs.fpk_name }}"
          ls -lh /tmp/FnDepot/fpk-cloudreve/

      - name: 14. æ›´æ–°FnDepotä»“åº“çš„fnpack.jsonä¸­fpk-cloudreveçš„ç‰ˆæœ¬å·
        if: steps.compare.outputs.need_update == 'true'
        run: |
          cd /tmp/FnDepot
          
          # æ£€æŸ¥fnpack.jsonæ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºï¼ˆåŸºç¡€ç»“æ„ï¼‰
          if [ ! -f "fnpack.json" ]; then
            echo '{"fpk-cloudreve": {"version": ""}}' > fnpack.json
            echo "âœ… åˆ›å»ºé»˜è®¤çš„fnpack.jsonæ–‡ä»¶"
          fi
          
          # ä½¿ç”¨jqå·¥å…·æ›´æ–°ç‰ˆæœ¬å·ï¼ˆæ ¸å¿ƒï¼šä¿®æ”¹fpk-cloudreveå¯¹åº”çš„versionï¼‰
          jq --arg ver "${{ steps.remote_ver.outputs.remote_version }}" \
            '.["fpk-cloudreve"].version = $ver' fnpack.json > fnpack.tmp && mv fnpack.tmp fnpack.json
          
          echo "âœ… fnpack.jsonæ›´æ–°å®Œæˆï¼Œå½“å‰å†…å®¹ï¼š"
          cat fnpack.json

      - name: 15. æ›´æ–°FnDepotä»“åº“æ ¹ç›®å½•README.mdä¸­çš„Cloudreveç‰ˆæœ¬å·
        if: steps.compare.outputs.need_update == 'true'
        run: |
          cd /tmp/FnDepot
          
          # æ£€æŸ¥README.mdæ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºåŸºç¡€æ–‡ä»¶
          if [ ! -f "README.md" ]; then
            echo "# FnDepot\n\n## ç»„ä»¶ç‰ˆæœ¬\n- Cloudreve: v${{ steps.remote_ver.outputs.remote_version }}\n" > README.md
            echo "âœ… åˆ›å»ºé»˜è®¤çš„README.mdæ–‡ä»¶"
          else
            # æ–¹æ¡ˆ1ï¼šé€šç”¨åŒ¹é… - æ›´æ–°æ‰€æœ‰åŒ…å« "Cloudreve: v[ç‰ˆæœ¬å·]" çš„è¡Œ
            sed -i -E \
              "s/(Cloudreve[[:space:]]*:[[:space:]]*v?)[0-9a-zA-Z.]+/\1${{ steps.remote_ver.outputs.remote_version }}/g" \
              README.md
              
            # æ–¹æ¡ˆ2ï¼ˆå¤‡ç”¨ï¼‰ï¼šå¦‚æœæ˜¯è¡¨æ ¼å½¢å¼ï¼ŒåŒ¹é…è¡¨æ ¼ä¸­çš„ç‰ˆæœ¬å·ï¼ˆå–æ¶ˆæ³¨é‡Šå¯ç”¨ï¼‰
            # sed -i -E \
            #   "s/(|[:space:]*Cloudreve[:space:]*|[:space:]*v?)[0-9a-zA-Z.]+([:space:]*|)/\1${{ steps.remote_ver.outputs.remote_version }}\2/g" \
            #   README.md
              
            echo "âœ… README.mdä¸­Cloudreveç‰ˆæœ¬å·²æ›´æ–°ä¸ºï¼šv${{ steps.remote_ver.outputs.remote_version }}"
          fi
          
          # è¾“å‡ºæ›´æ–°åçš„README.mdå†…å®¹ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
          echo "ğŸ“„ æ›´æ–°åçš„README.mdå…³é”®å†…å®¹ï¼š"
          grep -i "cloudreve" README.md || echo "æœªæ‰¾åˆ°Cloudreveç›¸å…³è¡Œ"

      - name: 16. æäº¤å¹¶æ¨é€fpkæ–‡ä»¶ã€fnpack.jsonå’ŒREADME.mdåˆ°FnDepotä»“åº“
        if: steps.compare.outputs.need_update == 'true'
        run: |
          cd /tmp/FnDepot
          
          # æš‚å­˜æ‰€æœ‰å˜æ›´ï¼ˆfpkæ–‡ä»¶ + fnpack.json + README.mdï¼‰
          git add fpk-cloudreve/${{ steps.build_fpk.outputs.fpk_name }} fnpack.json README.md
          
          # æäº¤å˜æ›´ï¼ˆå¤‡æ³¨ç‰ˆæœ¬å·ï¼‰
          git commit -m "chore: æ›´æ–°Cloudreve ${{ steps.remote_ver.outputs.remote_version }} fpkåŒ…ã€fnpack.jsonåŠREADME.mdç‰ˆæœ¬å·" || echo "âœ… æ— éœ€è¦æäº¤çš„å˜æ›´"
          
          # æ¨é€å˜æ›´åˆ°FnDepotä»“åº“mainåˆ†æ”¯ï¼ˆæ ¹æ®å®é™…åˆ†æ”¯ä¿®æ”¹ï¼‰
          git push origin main
          echo "âœ… æ‰€æœ‰å˜æ›´å·²æ¨é€åˆ° https://github.com/moxyis/FnDepot/tree/main/fpk-cloudreve"

      # ===================== æ–°å¢ï¼šä¸Šä¼ FPKåˆ°å½“å‰ä»“åº“çš„GitHub Releases =====================
      - name: 17. åˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ FPKæ–‡ä»¶
        if: steps.compare.outputs.need_update == 'true'
        uses: softprops/action-gh-release@v2
        with:
          # Releaseæ ‡ç­¾ï¼ˆå¸¦ç‰ˆæœ¬å·ï¼Œä¾¿äºè¯†åˆ«ï¼‰
          tag_name: "cloudreve-v${{ steps.remote_ver.outputs.remote_version }}"
          # Releaseæ ‡é¢˜
          name: "Cloudreve v${{ steps.remote_ver.outputs.remote_version }} æ‰“åŒ…ç‰ˆ"
          # Releaseæè¿°
          body: |
            ## Cloudreve è‡ªåŠ¨æ‰“åŒ…æ›´æ–°
            - ç‰ˆæœ¬ï¼šv${{ steps.remote_ver.outputs.remote_version }}
            - æ‰“åŒ…æ ¼å¼ï¼šfpk
            - é€‚é…æ¶æ„ï¼šLinux AMD64
            - æ›´æ–°æ—¶é—´ï¼š${{ github.run_at }}
            - æ‰“åŒ…å·¥å…·ï¼šfnpack 1.0.4
            - FnDepotä»“åº“ï¼šhttps://github.com/moxyis/FnDepot/tree/main/fpk-cloudreve
          # æ˜¯å¦ä¸ºé¢„å‘å¸ƒï¼ˆfalseè¡¨ç¤ºæ­£å¼å‘å¸ƒï¼‰
          prerelease: false
          # ä¸Šä¼ å¸¦ç‰ˆæœ¬å·çš„fpkæ–‡ä»¶
          files: ${{ steps.build_fpk.outputs.fpk_release_file }}
          # è¦†ç›–åŒåæ ‡ç­¾ï¼ˆé¿å…é‡å¤åˆ›å»ºå¤±è´¥ï¼‰
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
