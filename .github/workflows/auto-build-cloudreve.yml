name: 自动打包 Cloudreve（fnpack）

on:
  workflow_dispatch:
    inputs:
      debug_mode:
        description: '调试模式（true=仅构建不推送）'
        required: true
        default: 'false'
        type: boolean
  schedule:
    - cron: '0 0 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 安装依赖
        run: sudo apt update && sudo apt install -y jq curl

      - name: 读取本地版本
        id: local
        run: |
          if [ -f Cloudreve/manifest ]; then
            v=$(sed -n 's/^version:[[:space:]]*//p' Cloudreve/manifest | sed 's/^v//')
          else
            v="0.0.0"
          fi
          echo "version=$v" >> $GITHUB_OUTPUT

      - name: 获取 Cloudreve 最新版本
        id: remote
        run: |
          v=$(curl -s https://api.github.com/repos/cloudreve/Cloudreve/releases/latest | jq -r '.tag_name' | sed 's/^v//')
          [ -z "$v" -o "$v" = "null" ] && exit 1
          echo "version=$v" >> $GITHUB_OUTPUT

      - name: 判断是否需要构建
        id: check
        run: |
          if [ "${{ steps.local.outputs.version }}" = "${{ steps.remote.outputs.version }}" ]; then
            echo "need=false" >> $GITHUB_OUTPUT
          else
            echo "need=true" >> $GITHUB_OUTPUT
          fi

      - name: 安装 fnpack
        if: steps.check.outputs.need == 'true'
        run: |
          curl -SL -o /usr/local/bin/fnpack https://static2.fnnas.com/fnpack/fnpack-1.2.0-linux-amd64
          chmod +x /usr/local/bin/fnpack

      - name: 构建 x86 / arm FPK
        if: steps.check.outputs.need == 'true'
        id: build
        run: |
          set -e
          VERSION="${{ steps.remote.outputs.version }}"
          RELEASE_FILES=""

          for ARCH in x86 arm; do
            if [ "$ARCH" = "x86" ]; then
              KEY="linux_amd64"
            else
              KEY="linux_arm64"
            fi

            URL=$(curl -s https://api.github.com/repos/cloudreve/Cloudreve/releases/latest \
              | jq -r ".assets[] | select(.name | contains(\"$KEY.tar.gz\")) | .browser_download_url" | head -n1)

            [ -z "$URL" ] && exit 1

            WORKDIR="Cloudreve_$ARCH"
            cp -r Cloudreve "$WORKDIR"

            curl -L -o /tmp/cloudreve.tar.gz "$URL"
            tar -zxf /tmp/cloudreve.tar.gz -C /tmp

            mv /tmp/cloudreve "$WORKDIR/app/bin/cloudreve"
            chmod +x "$WORKDIR/app/bin/cloudreve"

            echo -e "version: $VERSION\nplatform: $ARCH" > "$WORKDIR/manifest"

            cd "$WORKDIR"
            fnpack build
            FPK=$(ls *.fpk)
            OUT="/tmp/fpk-cloudreve-v$VERSION-$ARCH.fpk"
            mv "$FPK" "$OUT"
            RELEASE_FILES="$RELEASE_FILES $OUT"
            cd -
          done

          echo "files=$RELEASE_FILES" >> $GITHUB_OUTPUT

      - name: 更新主 manifest
        if: steps.check.outputs.need == 'true' && github.event.inputs.debug_mode != 'true'
        run: |
          sed -i -E "s/^version:.*/version: ${{ steps.remote.outputs.version }}/" Cloudreve/manifest
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add Cloudreve/manifest
          git commit -m "chore: update Cloudreve v${{ steps.remote.outputs.version }}" || true
          git push

      - name: 创建 Release
        if: steps.check.outputs.need == 'true' && github.event.inputs.debug_mode != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: cloudreve-v${{ steps.remote.outputs.version }}
          name: Cloudreve v${{ steps.remote.outputs.version }}
          files: ${{ steps.build.outputs.files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
