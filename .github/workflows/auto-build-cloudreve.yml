name: ç‰ˆæœ¬æ¯”å¯¹åè‡ªåŠ¨æ‰“åŒ…Cloudreveå¹¶æ›´æ–°ä»“åº“

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * *'  

# å…¨å±€ç¯å¢ƒå˜é‡ï¼šè°ƒè¯•å¼€å…³ï¼ˆtrue=å¼€å¯è°ƒè¯•/ç¦ç”¨æ¨é€ï¼Œfalse=ç”Ÿäº§æ¨¡å¼/æ­£å¸¸æ¨é€ï¼‰
env:
  DEBUG_MODE: "true"  # è°ƒè¯•æ—¶è®¾ä¸ºtrueï¼Œç”Ÿäº§æ—¶è®¾ä¸ºfalse

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æˆäºˆå†™å…¥ä»“åº“/åˆ›å»ºReleaseæƒé™
      pull-requests: read
    strategy:
      fail-fast: false  # ä¸€ä¸ªæ¶æ„å¤±è´¥ä¸å½±å“å¦ä¸€ä¸ª
      matrix:
        # å®šä¹‰æ¶æ„æ˜ å°„ï¼šAMD64â†’x86ï¼ŒARM64â†’arm
        arch_config:
          - { arch: "Linux-AMD64", platform: "x86", asset_match: "linux_amd64.tar.gz" }
          - { arch: "Linux-ARM64", platform: "arm", asset_match: "linux_arm64.tar.gz" }

    steps:
      # ===================== ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡ =====================
      - name: 1. æ£€å‡ºå½“å‰ä»“åº“ä»£ç ï¼ˆå¸¦å®Œæ•´å†å²ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´æ£€å‡ºå†å²
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. é…ç½®Gitå…¨å±€èº«ä»½ï¼ˆè·¨ä»“åº“æ¨é€é€šç”¨ï¼‰
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # è°ƒè¯•æ¨¡å¼ï¼šè¾“å‡ºGité…ç½®
          if [ "$DEBUG_MODE" = "true" ]; then
            echo "===== è°ƒè¯•ä¿¡æ¯ï¼šGité…ç½® ====="
            git config --list
            echo "============================"
          fi

      - name: 3. å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆjq/curl/sedï¼‰
        run: |
          sudo apt update && sudo apt install -y jq curl sed
          echo "åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆ"
          
          # è°ƒè¯•æ¨¡å¼ï¼šè¾“å‡ºç³»ç»Ÿä¿¡æ¯å’Œç¯å¢ƒå˜é‡
          if [ "$DEBUG_MODE" = "true" ]; then
            echo "===== è°ƒè¯•ä¿¡æ¯ï¼šç³»ç»Ÿæ¶æ„ ====="
            uname -a
            echo "===== è°ƒè¯•ä¿¡æ¯ï¼šç¯å¢ƒå˜é‡ ====="
            env | grep -E "DEBUG|PLATFORM|ARCH|VERSION"
            echo "============================"
          fi

      # ===================== ç¬¬äºŒæ­¥ï¼šç‰ˆæœ¬æ¯”å¯¹ï¼ˆæ ¸å¿ƒå‰ç½®ï¼‰ =====================
      - name: 4. è¯»å–æœ¬åœ°manifestç‰ˆæœ¬å·
        id: local_ver
        run: |
          MANIFEST_PATH="Cloudreve/${{ matrix.arch_config.platform }}/manifest"
          if [ -f "$MANIFEST_PATH" ]; then
            LOCAL_VERSION=$(sed -n 's/^[[:space:]]*version[[:space:]]*[:=][[:space:]]*//p' "$MANIFEST_PATH" \
              | tr -d '"' | tr -d "'" | sed 's/^v//' | xargs)
            echo "æœ¬åœ°${{ matrix.arch_config.platform }}æ¶æ„manifestç‰ˆæœ¬ï¼š$LOCAL_VERSION"
            echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT
          else
            echo "âŒ æœªæ‰¾åˆ°$MANIFEST_PATHï¼Œå¼ºåˆ¶è§¦å‘æ›´æ–°"
            echo "local_version=0.0.0" >> $GITHUB_OUTPUT
            mkdir -p "Cloudreve/${{ matrix.arch_config.platform }}"
            echo "version: 0.0.0" > "$MANIFEST_PATH"
            git add "$MANIFEST_PATH"
            
            # è°ƒè¯•æ¨¡å¼ï¼šä»…æœ¬åœ°æäº¤ï¼Œä¸æ¨é€
            if [ "$DEBUG_MODE" = "true" ]; then
              echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šä»…æœ¬åœ°æš‚å­˜manifestï¼Œä¸æäº¤"
            else
              git commit -m "chore: åˆå§‹åŒ–${{ matrix.arch_config.platform }}æ¶æ„manifestæ–‡ä»¶" || echo "æ— éœ€è¦æäº¤çš„å˜æ›´"
            fi
          fi

      - name: 5. è·å–Cloudreveå®˜æ–¹æœ€æ–°æ­£å¼ç‰ˆç‰ˆæœ¬å·
        id: remote_ver
        run: |
          REMOTE_VERSION=$(curl -sSL --retry 3 --connect-timeout 10 \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/cloudreve/Cloudreve/releases/latest" \
            | jq -r '.tag_name' | sed 's/^v//' | xargs)
          
          if [ -z "$REMOTE_VERSION" ] || [ "$REMOTE_VERSION" = "null" ]; then
            echo "âŒ è·å–è¿œç¨‹ç‰ˆæœ¬å¤±è´¥"
            exit 1
          fi
          
          echo "è¿œç¨‹æœ€æ–°ç‰ˆæœ¬ï¼š$REMOTE_VERSION"
          echo "remote_version=$REMOTE_VERSION" >> $GITHUB_OUTPUT
          # ä¼ é€’æ¶æ„å’Œplatformå‚æ•°
          echo "arch=${{ matrix.arch_config.arch }}" >> $GITHUB_OUTPUT
          echo "platform=${{ matrix.arch_config.platform }}" >> $GITHUB_OUTPUT
          echo "asset_match=${{ matrix.arch_config.asset_match }}" >> $GITHUB_OUTPUT

      - name: 6. ç‰ˆæœ¬æ¯”å¯¹ï¼Œåˆ¤æ–­æ˜¯å¦æ›´æ–°
        id: compare
        run: |
          if [ "${{ steps.local_ver.outputs.local_version }}" = "${{ steps.remote_ver.outputs.remote_version }}" ]; then
            echo "âœ… ${{ matrix.arch_config.platform }}æ¶æ„æœ¬åœ°ç‰ˆæœ¬ä¸è¿œç¨‹ç‰ˆæœ¬ä¸€è‡´ï¼ˆ${{ steps.remote_ver.outputs.remote_version }}ï¼‰ï¼Œæ— éœ€æ›´æ–°"
            echo "need_update=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ ${{ matrix.arch_config.platform }}æ¶æ„ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå¼€å§‹æ›´æ–°æ‰“åŒ…æµç¨‹"
            echo "need_update=true" >> $GITHUB_OUTPUT
          fi

      # ===================== ç¬¬ä¸‰æ­¥ï¼šä»…ç‰ˆæœ¬ä¸ä¸€è‡´æ—¶æ‰§è¡Œ =====================
      - name: 7. ä¸‹è½½å¯¹åº”æ¶æ„çš„Cloudreveå®‰è£…åŒ…
        if: steps.compare.outputs.need_update == 'true'
        id: download_cloudreve
        run: |
          set -euo pipefail
          
          # 1. è·å–å®Œæ•´å‘è¡Œç‰ˆæ•°æ®
          RELEASE_DATA=$(curl -sSL --retry 3 --connect-timeout 10 \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/cloudreve/Cloudreve/releases/latest")
          
          # 2. è°ƒè¯•ï¼šè¾“å‡ºæ‰€æœ‰èµ„äº§åç§°
          if [ "$DEBUG_MODE" = "true" ]; then
            echo "===== è°ƒè¯•ä¿¡æ¯ï¼šè¿œç¨‹å‘è¡Œç‰ˆæ‰€æœ‰èµ„äº§ ====="
            echo "$RELEASE_DATA" | jq -r '.assets[].name'
            echo "======================================"
          fi
          
          # 3. åŒ¹é…å¯¹åº”æ¶æ„çš„å®‰è£…åŒ…
          DOWNLOAD_URL=$(echo "$RELEASE_DATA" | jq -r \
            '.assets[] | select(.name | contains("${{ steps.remote_ver.outputs.asset_match }}")) | .browser_download_url' | head -n1)
          
          # 4. æœ€ç»ˆæ ¡éªŒ
          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
            echo "âŒ æœªæ‰¾åˆ°åŒ…å« '${{ steps.remote_ver.outputs.asset_match }}' çš„èµ„äº§"
            exit 1
          fi
          
          # 5. æå–åŒ¹é…åˆ°çš„èµ„äº§å
          MATCHED_ASSET=$(echo "$RELEASE_DATA" | jq -r '.assets[] | select(.name | contains("${{ steps.remote_ver.outputs.asset_match }}")) | .name' | head -n1)
          echo "âœ… åŒ¹é…åˆ°ç›®æ ‡èµ„äº§ï¼š$MATCHED_ASSET"
          echo "âœ… ä¸‹è½½é“¾æ¥ï¼š$DOWNLOAD_URL"
          
          # 6. åˆ›å»ºç›®å½•å¹¶ä¸‹è½½
          mkdir -p "Cloudreve/${{ steps.remote_ver.outputs.platform }}/app/bin"
          curl -SL --retry 3 --connect-timeout 10 -o /tmp/cloudreve.tar.gz "$DOWNLOAD_URL"
          
          # 7. è§£å‹å¹¶éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶
          tar -zxf /tmp/cloudreve.tar.gz -C /tmp
          if [ ! -f "/tmp/cloudreve" ]; then
            echo "âŒ è§£å‹åæœªæ‰¾åˆ°cloudreveäºŒè¿›åˆ¶æ–‡ä»¶"
            exit 1
          fi
          
          # 8. ç§»åŠ¨æ–‡ä»¶+æ·»åŠ æ‰§è¡Œæƒé™
          mv /tmp/cloudreve "Cloudreve/${{ steps.remote_ver.outputs.platform }}/app/bin/"
          chmod +x "Cloudreve/${{ steps.remote_ver.outputs.platform }}/app/bin/cloudreve"
          rm -rf /tmp/cloudreve.tar.gz /tmp/cloudreve
          
          # 9. éªŒè¯æ–‡ä»¶ä¿¡æ¯
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶ä¿¡æ¯ï¼š"
          ls -lh "Cloudreve/${{ steps.remote_ver.outputs.platform }}/app/bin/cloudreve"
          file "Cloudreve/${{ steps.remote_ver.outputs.platform }}/app/bin/cloudreve"

      - name: 8. æ›´æ–°å¯¹åº”æ¶æ„manifestçš„versionå­—æ®µ
        if: steps.compare.outputs.need_update == 'true'
        run: |
          MANIFEST_PATH="Cloudreve/${{ steps.remote_ver.outputs.platform }}/manifest"
          # æ›´æ–°ç‰ˆæœ¬å·
          sed -i -E \
            "s/(^[[:space:]]*version[[:space:]]*[:=][[:space:]]*)([\"']?)([0-9a-zA-Z.]+)([\"']?)/\1\2${{ steps.remote_ver.outputs.remote_version }}\4/" \
            "$MANIFEST_PATH"
          
          echo "âœ… ${{ steps.remote_ver.outputs.platform }}æ¶æ„manifestç‰ˆæœ¬å·²æ›´æ–°ä¸ºï¼š${{ steps.remote_ver.outputs.remote_version }}"
          cat "$MANIFEST_PATH" | grep -i version

          # æš‚å­˜å˜æ›´
          git add "$MANIFEST_PATH"

      - name: 9. æäº¤å¹¶æ¨é€manifestå˜æ›´åˆ°å½“å‰ä»“åº“
        if: steps.compare.outputs.need_update == 'true' && env.DEBUG_MODE == 'false'
        run: |
          git commit -m "chore: æ›´æ–°${{ steps.remote_ver.outputs.platform }}æ¶æ„Cloudreveç‰ˆæœ¬è‡³${{ steps.remote_ver.outputs.remote_version }}" || echo "âœ… æ— éœ€è¦æäº¤çš„manifestå˜æ›´"
          git push origin HEAD:${{ github.ref_name }}
          echo "âœ… ${{ steps.remote_ver.outputs.platform }}æ¶æ„manifestç‰ˆæœ¬å·å·²æ¨é€åˆ°å½“å‰ä»“åº“"
      - name: 9.ã€è°ƒè¯•æ¨¡å¼ã€‘è·³è¿‡manifestæ¨é€
        if: steps.compare.outputs.need_update == 'true' && env.DEBUG_MODE == 'true'
        run: |
          echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡manifestçš„æäº¤å’Œæ¨é€æ“ä½œ"

      - name: 10. ä¸‹è½½å¹¶å®‰è£…fnpackï¼ˆæŒ‡å®šåœ°å€ï¼‰
        if: steps.compare.outputs.need_update == 'true'
        run: |
          FNPACK_URL="https://static2.fnnas.com/fnpack/fnpack-1.2.0-linux-amd64"
          curl -SL --retry 3 --connect-timeout 10 -o /usr/local/bin/fnpack "$FNPACK_URL"
          chmod +x /usr/local/bin/fnpack
          
          if ! command -v fnpack &>/dev/null; then
            echo "âŒ fnpackå®‰è£…å¤±è´¥"
            exit 1
          fi
          
          # è°ƒè¯•æ¨¡å¼ï¼šè¾“å‡ºfnpackç‰ˆæœ¬ä¿¡æ¯
          if [ "$DEBUG_MODE" = "true" ]; then
            echo "===== è°ƒè¯•ä¿¡æ¯ï¼šfnpackç‰ˆæœ¬ ====="
            fnpack --version || echo "fnpackæ— --versionå‚æ•°"
            echo "=============================="
          fi
          echo "âœ… fnpackå®‰è£…å®Œæˆï¼š$(which fnpack)"

      - name: 11. è¿›å…¥å¯¹åº”æ¶æ„ç›®å½•æ‰§è¡Œfnpackæ‰“åŒ…ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼‰
        if: steps.compare.outputs.need_update == 'true'
        id: build_fpk
        run: |
          # è¿›å…¥å¯¹åº”æ¶æ„çš„Cloudreveç›®å½•
          cd "Cloudreve/${{ steps.remote_ver.outputs.platform }}"
          
          # è°ƒè¯•æ¨¡å¼ï¼šè¾“å‡ºå½“å‰ç›®å½•ç»“æ„
          if [ "$DEBUG_MODE" = "true" ]; then
            echo "===== è°ƒè¯•ä¿¡æ¯ï¼šæ‰“åŒ…å‰ç›®å½•ç»“æ„ ====="
            ls -lhR .
            echo "=================================="
          fi
          
          echo "ğŸš€ è¿›å…¥${{ steps.remote_ver.outputs.platform }}æ¶æ„ç›®å½•ï¼Œæ‰§è¡Œæ‰“åŒ…å‘½ä»¤ï¼šfnpack build"
          fnpack build
          
          # æŸ¥æ‰¾æ‰“åŒ…åçš„fpkæ–‡ä»¶
          FPK_FILE=$(find . -name "*.fpk" -type f | head -n1)
          if [ -z "$FPK_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ°æ‰“åŒ…åçš„fpkæ–‡ä»¶"
            exit 1
          fi
          
          # æ‹¼æ¥å®Œæ•´è·¯å¾„
          FPK_FULL_PATH=$(pwd)/$FPK_FILE
          # å¸¦platform+ç‰ˆæœ¬å·+æ¶æ„çš„å›ºå®šåç§°ï¼ˆæ¨FnDepotï¼‰
          FPK_FIXED_NAME="fpk-cloudreve-${{ steps.remote_ver.outputs.platform }}.fpk"
          # å¸¦ç‰ˆæœ¬å·+æ¶æ„+platformçš„åç§°ï¼ˆä¼ Releaseï¼‰
          FPK_VERSION_NAME="fpk-cloudreve-v${{ steps.remote_ver.outputs.remote_version }}-${{ steps.remote_ver.outputs.arch }}-${{ steps.remote_ver.outputs.platform }}.fpk"
          
          # å¤åˆ¶æ–‡ä»¶
          mv "$FPK_FULL_PATH" /tmp/$FPK_FIXED_NAME
          cp /tmp/$FPK_FIXED_NAME /tmp/$FPK_VERSION_NAME
          
          echo "âœ… fnpackæ‰“åŒ…å®Œæˆï¼š"
          echo "  - å›ºå®šåç§°ï¼š/tmp/$FPK_FIXED_NAME"
          echo "  - ç‰ˆæœ¬+æ¶æ„åç§°ï¼š/tmp/$FPK_VERSION_NAME"
          
          # è°ƒè¯•æ¨¡å¼ï¼šè¾“å‡ºfpkæ–‡ä»¶è¯¦æƒ…
          if [ "$DEBUG_MODE" = "true" ]; then
            echo "===== è°ƒè¯•ä¿¡æ¯ï¼šFPKæ–‡ä»¶è¯¦æƒ… ====="
            ls -lh /tmp/$FPK_FIXED_NAME
            sha256sum /tmp/$FPK_VERSION_NAME
            echo "================================"
          fi
          
          echo "fpk_file=/tmp/$FPK_FIXED_NAME" >> $GITHUB_OUTPUT
          echo "fpk_name=$FPK_FIXED_NAME" >> $GITHUB_OUTPUT
          echo "fpk_release_file=/tmp/$FPK_VERSION_NAME" >> $GITHUB_OUTPUT
          echo "fpk_release_name=$FPK_VERSION_NAME" >> $GITHUB_OUTPUT

      # ===================== ç¬¬å››æ­¥ï¼šæ¨é€fpkåˆ°FnDepotä»“åº“ + æ›´æ–°fnpack.json + æ›´æ–°README.md =====================
      - name: 12. å…‹éš†FnDepotä»“åº“ï¼ˆç›®æ ‡ä»“åº“ï¼‰
        if: steps.compare.outputs.need_update == 'true' && env.DEBUG_MODE == 'false'
        run: |
          # ä½¿ç”¨PATä»¤ç‰Œå…‹éš†ï¼ˆéœ€åœ¨å½“å‰ä»“åº“Secretsé…ç½® FnDepot_PATï¼‰
          git clone https://${{ secrets.FnDepot_PAT }}@github.com/moxyis/FnDepot.git /tmp/FnDepot
          echo "âœ… æˆåŠŸå…‹éš†FnDepotä»“åº“åˆ°/tmp/FnDepot"
      - name: 12.ã€è°ƒè¯•æ¨¡å¼ã€‘è·³è¿‡FnDepotå…‹éš†
        if: steps.compare.outputs.need_update == 'true' && env.DEBUG_MODE == 'true'
        run: |
          echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡FnDepotä»“åº“çš„å…‹éš†æ“ä½œ"

      - name: 13. å¤åˆ¶fpkæ–‡ä»¶åˆ°FnDepotä»“åº“ç›®æ ‡ç›®å½•ï¼ˆè¦†ç›–æ—§æ–‡ä»¶ï¼‰
        if: steps.compare.outputs.need_update == 'true' && env.DEBUG_MODE == 'false'
        run: |
          # åˆ›å»ºç›®æ ‡æ–‡ä»¶å¤¹ï¼ˆæŒ‰platformåŒºåˆ†ï¼‰
          mkdir -p /tmp/FnDepot/fpk-cloudreve/${{ steps.remote_ver.outputs.platform }}
          
          # å…ˆåˆ é™¤æ—§çš„fpkæ–‡ä»¶
          rm -f /tmp/FnDepot/fpk-cloudreve/${{ steps.remote_ver.outputs.platform }}/${{ steps.build_fpk.outputs.fpk_name }}
          
          # å¤åˆ¶æ–°çš„fpkæ–‡ä»¶
          cp ${{ steps.build_fpk.outputs.fpk_file }} /tmp/FnDepot/fpk-cloudreve/${{ steps.remote_ver.outputs.platform }}/
          
          echo "âœ… fpkæ–‡ä»¶å·²å¤åˆ¶åˆ°ï¼š/tmp/FnDepot/fpk-cloudreve/${{ steps.remote_ver.outputs.platform }}/${{ steps.build_fpk.outputs.fpk_name }}"
          ls -lh /tmp/FnDepot/fpk-cloudreve/${{ steps.remote_ver.outputs.platform }}/
      - name: 13.ã€è°ƒè¯•æ¨¡å¼ã€‘è·³è¿‡fpkæ–‡ä»¶å¤åˆ¶
        if: steps.compare.outputs.need_update == 'true' && env.DEBUG_MODE == 'true'
        run: |
          echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡fpkæ–‡ä»¶å¤åˆ¶åˆ°FnDepotä»“åº“çš„æ“ä½œ"

      - name: 14. æ›´æ–°FnDepotä»“åº“çš„fnpack.jsonä¸­å¯¹åº”platformçš„ç‰ˆæœ¬å·
        if: steps.compare.outputs.need_update == 'true' && env.DEBUG_MODE == 'false'
        run: |
          cd /tmp/FnDepot
          
          # æ£€æŸ¥fnpack.jsonæ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
          if [ ! -f "fnpack.json" ]; then
            echo '{"fpk-cloudreve": {"x86": {"version": ""}, "arm": {"version": ""}}}' > fnpack.json
            echo "âœ… åˆ›å»ºé»˜è®¤çš„fnpack.jsonæ–‡ä»¶"
          fi
          
          # ä½¿ç”¨jqå·¥å…·æ›´æ–°å¯¹åº”platformçš„ç‰ˆæœ¬å·
          jq --arg plat "${{ steps.remote_ver.outputs.platform }}" --arg ver "${{ steps.remote_ver.outputs.remote_version }}" \
            '.["fpk-cloudreve"][$plat].version = $ver' fnpack.json > fnpack.tmp && mv fnpack.tmp fnpack.json
          
          echo "âœ… fnpack.jsonæ›´æ–°å®Œæˆï¼Œå½“å‰å†…å®¹ï¼š"
          cat fnpack.json
      - name: 14.ã€è°ƒè¯•æ¨¡å¼ã€‘è·³è¿‡fnpack.jsonæ›´æ–°
        if: steps.compare.outputs.need_update == 'true' && env.DEBUG_MODE == 'true'
        run: |
          echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡FnDepotä»“åº“fnpack.jsonçš„æ›´æ–°æ“ä½œ"

      - name: 15. æ›´æ–°FnDepotä»“åº“æ ¹ç›®å½•README.mdä¸­å¯¹åº”æ¶æ„çš„ç‰ˆæœ¬å·
        if: steps.compare.outputs.need_update == 'true' && env.DEBUG_MODE == 'false'
        run: |
          cd /tmp/FnDepot
          
          # æ£€æŸ¥README.mdæ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºåŸºç¡€æ–‡ä»¶
          if [ ! -f "README.md" ]; then
            echo "# FnDepot\n\n| **Cloudreve** | x86 | arm | é“¾æ¥ |\n|---------------|-----|-----|------|\n| ç‰ˆæœ¬å·        | ${{ steps.remote_ver.outputs.remote_version }} | ${{ steps.remote_ver.outputs.remote_version }} | Cloudreve/https://cloudreve.org/ |\n\nCloudreveæ˜¯é€šè¿‡Github-Actionsè¿›è¡Œæ¯å¤©è‡ªåŠ¨åŒ–æ£€æµ‹æœ€æ–°Cloudreveæ­£å¼ç‰ˆæœ¬è¿›è¡Œæ‰“åŒ…æ¨é€åˆ°æœ¬ä»“åº“ï¼Œä¸Šæ–¹çš„åº”ç”¨æ¸…å•çš„Cloudreveå¯¹åº”ç‰ˆæœ¬å·å·²æŒ‰æ¶æ„è‡ªåŠ¨æ›´æ–°\nè„šæœ¬è‡ªåŠ¨åŒ–ä»“åº“ï¼šhttps://github.com/moxyis/fpk-cloudreve" > README.md
            echo "âœ… åˆ›å»ºé»˜è®¤çš„README.mdæ–‡ä»¶ï¼ˆåŒ¹é…å¤šæ¶æ„è¡¨æ ¼æ ¼å¼ï¼‰"
          else
            # åŒºåˆ†x86/armæ›´æ–°å¯¹åº”è¡Œçš„ç‰ˆæœ¬å·
            if [ "${{ steps.remote_ver.outputs.platform }}" = "x86" ]; then
              sed -i -E \
                "s/(\|\s*ç‰ˆæœ¬å·\s*\|\s*)[0-9.]+\s*(\|\s*)[0-9.]+\s*(\|\s*Cloudreve\/https:\/\/cloudreve.org\/\s*\|)/\1${{ steps.remote_ver.outputs.remote_version }}\2\3\4/g" \
                README.md
            else
              sed -i -E \
                "s/(\|\s*ç‰ˆæœ¬å·\s*\|\s*)[0-9.]+\s*(\|\s*)[0-9.]+\s*(\|\s*Cloudreve\/https:\/\/cloudreve.org\/\s*\|)/\1\2${{ steps.remote_ver.outputs.remote_version }}\3\4/g" \
                README.md
            fi
              
            echo "âœ… README.mdä¸­${{ steps.remote_ver.outputs.platform }}æ¶æ„ç‰ˆæœ¬å·²æ›´æ–°ä¸ºï¼š${{ steps.remote_ver.outputs.remote_version }}"
          fi
          
          # è¾“å‡ºæ›´æ–°åçš„README.mdå…³é”®å†…å®¹
          echo "ğŸ“„ æ›´æ–°åçš„README.mdå…³é”®å†…å®¹ï¼š"
          grep -A 2 -B 1 "Cloudreve" README.md
      - name: 15.ã€è°ƒè¯•æ¨¡å¼ã€‘è·³è¿‡README.mdæ›´æ–°
        if: steps.compare.outputs.need_update == 'true' && env.DEBUG_MODE == 'true'
        run: |
          echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡FnDepotä»“åº“README.mdçš„æ›´æ–°æ“ä½œ"

      - name: 16. æäº¤å¹¶æ¨é€æ‰€æœ‰å˜æ›´åˆ°FnDepotä»“åº“
        if: steps.compare.outputs.need_update == 'true' && env.DEBUG_MODE == 'false'
        run: |
          cd /tmp/FnDepot
          
          # æš‚å­˜æ‰€æœ‰å˜æ›´
          git add fpk-cloudreve/${{ steps.remote_ver.outputs.platform }}/${{ steps.build_fpk.outputs.fpk_name }} fnpack.json README.md
          
          # æäº¤å˜æ›´
          git commit -m "chore: æ›´æ–°${{ steps.remote_ver.outputs.platform }}æ¶æ„Cloudreveç‰ˆæœ¬è‡³${{ steps.remote_ver.outputs.remote_version }}" || echo "âœ… æ— éœ€è¦æäº¤çš„å˜æ›´"
          
          # æ¨é€å˜æ›´åˆ°FnDepotä»“åº“mainåˆ†æ”¯
          git push origin main
          echo "âœ… æ‰€æœ‰å˜æ›´å·²æ¨é€åˆ° https://github.com/moxyis/FnDepot/tree/main/fpk-cloudreve/${{ steps.remote_ver.outputs.platform }}"
      - name: 16.ã€è°ƒè¯•æ¨¡å¼ã€‘è·³è¿‡FnDepotæ¨é€
        if: steps.compare.outputs.need_update == 'true' && env.DEBUG_MODE == 'true'
        run: |
          echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡FnDepotä»“åº“çš„æäº¤å’Œæ¨é€æ“ä½œ"

      # ===================== æ–°å¢ï¼šä¸Šä¼ FPKåˆ°å½“å‰ä»“åº“çš„GitHub Releases =====================
      - name: 17. åˆ›å»º/æ›´æ–°GitHub Releaseå¹¶ä¸Šä¼ å¯¹åº”æ¶æ„FPKæ–‡ä»¶
        if: steps.compare.outputs.need_update == 'true' && env.DEBUG_MODE == 'false'
        uses: softprops/action-gh-release@v2
        with:
          # Releaseæ ‡ç­¾ï¼ˆç»Ÿä¸€ç‰ˆæœ¬+åŒºåˆ†æ¶æ„ï¼‰
          tag_name: "cloudreve-v${{ steps.remote_ver.outputs.remote_version }}"
          # Releaseæ ‡é¢˜
          name: "Cloudreve v${{ steps.remote_ver.outputs.remote_version }}"
          # Releaseæè¿°
          body: |
            ## Cloudreve è‡ªåŠ¨æ‰“åŒ…æ›´æ–°
            - ç‰ˆæœ¬ï¼šv${{ steps.remote_ver.outputs.remote_version }}
            - å¹³å°æ¶æ„ï¼š${{ steps.remote_ver.outputs.arch }}ï¼ˆplatform=${{ steps.remote_ver.outputs.platform }}ï¼‰
            - æ‰“åŒ…æ ¼å¼ï¼šfpk
            - æ›´æ–°æ—¶é—´ï¼š${{ github.run_at }}
            - æ‰“åŒ…å·¥å…·ï¼šfnpack 1.2.0
            - FnDepotä»“åº“ï¼šhttps://github.com/moxyis/FnDepot/tree/main/fpk-cloudreve/${{ steps.remote_ver.outputs.platform }}
          # æ˜¯å¦ä¸ºé¢„å‘å¸ƒ
          prerelease: false
          # ä¸Šä¼ å¯¹åº”æ¶æ„çš„fpkæ–‡ä»¶
          files: ${{ steps.build_fpk.outputs.fpk_release_file }}
          # è¦†ç›–åŒåæ ‡ç­¾ï¼ˆæ”¯æŒå¤šæ¶æ„æ–‡ä»¶ä¸Šä¼ ï¼‰
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: 17.ã€è°ƒè¯•æ¨¡å¼ã€‘è·³è¿‡Releaseä¸Šä¼ 
        if: steps.compare.outputs.need_update == 'true' && env.DEBUG_MODE == 'true'
        run: |
          echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡GitHub Releaseçš„åˆ›å»ºå’ŒFPKæ–‡ä»¶ä¸Šä¼ æ“ä½œ"
          # è°ƒè¯•æ¨¡å¼ï¼šè¾“å‡ºæœ€ç»ˆç”Ÿæˆçš„FPKæ–‡ä»¶åˆ—è¡¨
          echo "===== è°ƒè¯•ä¿¡æ¯ï¼šæœ€ç»ˆç”Ÿæˆçš„FPKæ–‡ä»¶ ====="
          ls -lh /tmp/*.fpk
          echo "======================================"
