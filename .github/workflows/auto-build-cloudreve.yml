name: ç‰ˆæœ¬æ¯”å¯¹åè‡ªåŠ¨æ‰“åŒ…å¤šæ¶æ„Cloudreve

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * *'  

# å…¨å±€è°ƒè¯•å¼€å…³ï¼štrue=è°ƒè¯•ï¼ˆç¦ç”¨æ¨é€ï¼‰ï¼Œfalse=ç”Ÿäº§
env:
  DEBUG_MODE: "true"

jobs:
  build-multi-arch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    steps:
      # ===================== ç¬¬ä¸€æ­¥ï¼šå…‹éš†ä»“åº“ & åˆå§‹åŒ–åŸºç¡€ç›®å½• =====================
      - name: 1. æ£€å‡ºå½“å‰ä»“åº“ï¼ˆå«CloudreveåŸºç¡€ç›®å½•ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. é…ç½®Gitèº«ä»½ï¼ˆè°ƒè¯•æ¨¡å¼ä»…æœ¬åœ°ç”Ÿæ•ˆï¼‰
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # è°ƒè¯•æ¨¡å¼ï¼šè¾“å‡ºä»“åº“ä¿¡æ¯
          if [ "$DEBUG_MODE" = "true" ]; then
            echo "===== è°ƒè¯•ï¼šå½“å‰ä»“åº“ç›®å½• ====="
            ls -lh
            echo "=============================="
          fi

      # ===================== ç¬¬äºŒæ­¥ï¼šç‰ˆæœ¬æ¯”å¯¹ï¼ˆæ ¸å¿ƒå‰ç½®ï¼‰ =====================
      - name: 3. è¯»å–åŸºç¡€manifestçš„ç‰ˆæœ¬å·
        id: read_version
        run: |
          # åˆå§‹åŒ–åŸºç¡€manifestï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰
          MANIFEST_PATH="Cloudreve/manifest"
          if [ ! -f "$MANIFEST_PATH" ]; then
            echo "version: 0.0.0" > "$MANIFEST_PATH"
            echo "platform: x86" >> "$MANIFEST_PATH"
            git add "$MANIFEST_PATH"
            echo "âš ï¸ åˆå§‹åŒ–åŸºç¡€manifestæ–‡ä»¶ï¼Œç‰ˆæœ¬å·ï¼š0.0.0"
          fi

          # è¯»å–ç»Ÿä¸€çš„ç‰ˆæœ¬å·ï¼ˆå¿½ç•¥platformï¼‰
          LOCAL_VERSION=$(sed -n 's/^[[:space:]]*version[[:space:]]*[:=][[:space:]]*//p' "$MANIFEST_PATH" \
            | tr -d '"' | tr -d "'" | sed 's/^v//' | xargs)
          echo "æœ¬åœ°åŸºç¡€ç‰ˆæœ¬å·ï¼š$LOCAL_VERSION"
          echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT

      - name: 4. è·å–Cloudreveå®˜æ–¹æœ€æ–°ç‰ˆæœ¬å·
        id: remote_version
        run: |
          REMOTE_VERSION=$(curl -sSL --retry 3 --connect-timeout 10 \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/cloudreve/Cloudreve/releases/latest" \
            | jq -r '.tag_name' | sed 's/^v//' | xargs)
          
          if [ -z "$REMOTE_VERSION" ] || [ "$REMOTE_VERSION" = "null" ]; then
            echo "âŒ è·å–è¿œç¨‹ç‰ˆæœ¬å¤±è´¥"
            exit 1
          fi
          
          echo "å®˜æ–¹æœ€æ–°ç‰ˆæœ¬å·ï¼š$REMOTE_VERSION"
          echo "remote_version=$REMOTE_VERSION" >> $GITHUB_OUTPUT

      - name: 5. ç‰ˆæœ¬æ¯”å¯¹ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
        id: compare
        run: |
          if [ "${{ steps.read_version.outputs.local_version }}" = "${{ steps.remote_version.outputs.remote_version }}" ]; then
            echo "âœ… æœ¬åœ°ç‰ˆæœ¬ä¸å®˜æ–¹ä¸€è‡´ï¼ˆ${{ steps.remote_version.outputs.remote_version }}ï¼‰ï¼Œæ— éœ€æ‰“åŒ…"
            echo "need_update=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå¼€å§‹å¤šæ¶æ„æ‰“åŒ…æµç¨‹"
            echo "need_update=true" >> $GITHUB_OUTPUT
          fi

      # ===================== ç¬¬ä¸‰æ­¥ï¼šç‰ˆæœ¬ä¸ä¸€è‡´æ—¶æ‰§è¡Œå¤šæ¶æ„æ‰“åŒ… =====================
      - name: 6. å¤åˆ¶åŸºç¡€ç›®å½•å¹¶ä¿®æ”¹platformå­—æ®µ
        if: steps.compare.outputs.need_update == 'true'
        run: |
          # 1. å¤åˆ¶åŸºç¡€Cloudreveç›®å½•ä¸ºx86/armä¸“å±ç›®å½•
          rm -rf Cloudreve-x86 Cloudreve-arm
          cp -r Cloudreve Cloudreve-x86
          cp -r Cloudreve Cloudreve-arm
          echo "âœ… å¤åˆ¶åŸºç¡€ç›®å½•ä¸ºï¼šCloudreve-x86 / Cloudreve-arm"

          # 2. ä¿®æ”¹x86ç›®å½•çš„platformä¸ºx86ï¼Œæ›´æ–°ç‰ˆæœ¬å·
          sed -i -E \
            -e "s/(^[[:space:]]*platform[[:space:]]*[:=][[:space:]]*)([\"']?)(.+)([\"']?)/\1\2x86\4/" \
            -e "s/(^[[:space:]]*version[[:space:]]*[:=][[:space:]]*)([\"']?)(.+)([\"']?)/\1\2${{ steps.remote_version.outputs.remote_version }}\4/" \
            Cloudreve-x86/manifest
          
          # 3. ä¿®æ”¹armç›®å½•çš„platformä¸ºarmï¼Œæ›´æ–°ç‰ˆæœ¬å·
          sed -i -E \
            -e "s/(^[[:space:]]*platform[[:space:]]*[:=][[:space:]]*)([\"']?)(.+)([\"']?)/\1\2arm\4/" \
            -e "s/(^[[:space:]]*version[[:space:]]*[:=][[:space:]]*)([\"']?)(.+)([\"']?)/\1\2${{ steps.remote_version.outputs.remote_version }}\4/" \
            Cloudreve-arm/manifest
          
          # è°ƒè¯•æ¨¡å¼ï¼šè¾“å‡ºä¿®æ”¹åçš„manifest
          if [ "$DEBUG_MODE" = "true" ]; then
            echo "===== è°ƒè¯•ï¼šx86 manifest ====="
            cat Cloudreve-x86/manifest
            echo "===== è°ƒè¯•ï¼šarm manifest ====="
            cat Cloudreve-arm/manifest
            echo "=============================="
          fi

      - name: 7. ä¸‹è½½å¹¶å®‰è£…fnpackæ‰“åŒ…å·¥å…·
        if: steps.compare.outputs.need_update == 'true'
        run: |
          FNPACK_URL="https://static2.fnnas.com/fnpack/fnpack-1.2.0-linux-amd64"
          curl -SL --retry 3 --connect-timeout 10 -o /usr/local/bin/fnpack "$FNPACK_URL"
          chmod +x /usr/local/bin/fnpack
          
          if ! command -v fnpack &>/dev/null; then
            echo "âŒ fnpackå®‰è£…å¤±è´¥"
            exit 1
          fi
          echo "âœ… fnpackå®‰è£…å®Œæˆï¼š$(which fnpack)"

      - name: 8. æ‰¹é‡æ‰“åŒ…x86/armæ¶æ„ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰
        if: steps.compare.outputs.need_update == 'true'
        id: build_packages
        run: |
          set -euo pipefail
          
          # å®šä¹‰æ¶æ„æ˜ å°„ï¼šç›®å½•å â†’ èµ„äº§åŒ¹é…å…³é”®è¯ â†’ æ‰“åŒ…æ–‡ä»¶å
          declare -A ARCH_CONFIG=(
            ["x86"]="linux_amd64.tar.gz"
            ["arm"]="linux_arm64.tar.gz"
          )
          
          # åˆ›å»ºäº§ç‰©ç›®å½•
          mkdir -p /tmp/cloudreve-packages
          RELEASE_FILES=""

          # éå†æ¶æ„æ‰“åŒ…
          for ARCH in "${!ARCH_CONFIG[@]}"; do
            DIR_NAME="Cloudreve-$ARCH"
            ASSET_MATCH=${ARCH_CONFIG[$ARCH]}
            echo -e "\n========== å¼€å§‹æ‰“åŒ… $ARCH æ¶æ„ =========="

            # 1. è·å–å¯¹åº”æ¶æ„çš„ä¸‹è½½é“¾æ¥
            RELEASE_DATA=$(curl -sSL --retry 3 --connect-timeout 10 \
              "https://api.github.com/repos/cloudreve/Cloudreve/releases/latest")
            DOWNLOAD_URL=$(echo "$RELEASE_DATA" | jq -r \
              '.assets[] | select(.name | contains("'"$ASSET_MATCH"'")) | .browser_download_url' | head -n1)
            
            if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
              echo "âŒ æœªæ‰¾åˆ° $ARCH æ¶æ„çš„èµ„äº§ï¼ˆåŒ¹é…ï¼š$ASSET_MATCHï¼‰"
              continue
            fi

            # 2. ä¸‹è½½å¹¶è§£å‹äºŒè¿›åˆ¶æ–‡ä»¶
            curl -SL --retry 3 --connect-timeout 10 -o /tmp/$ARCH.tar.gz "$DOWNLOAD_URL"
            tar -zxf /tmp/$ARCH.tar.gz -C /tmp
            if [ ! -f "/tmp/cloudreve" ]; then
              echo "âŒ $ARCH è§£å‹å¤±è´¥ï¼Œæœªæ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶"
              rm -f /tmp/$ARCH.tar.gz
              continue
            fi

            # 3. æ›¿æ¢ç›®å½•å†…çš„äºŒè¿›åˆ¶æ–‡ä»¶
            mv /tmp/cloudreve "$DIR_NAME/app/bin/"
            chmod +x "$DIR_NAME/app/bin/cloudreve"
            rm -f /tmp/$ARCH.tar.gz /tmp/cloudreve
            echo "âœ… $ARCH äºŒè¿›åˆ¶æ–‡ä»¶å·²æ›¿æ¢å®Œæˆ"

            # 4. æ‰§è¡Œfnpackæ‰“åŒ…
            cd "$DIR_NAME"
            fnpack build
            cd -

            # 5. ç§»åŠ¨æ‰“åŒ…äº§ç‰©
            FPK_FILE=$(find "$DIR_NAME" -name "*.fpk" -type f | head -n1)
            FPK_NAME="fpk-cloudreve-$ARCH-v${{ steps.remote_version.outputs.remote_version }}.fpk"
            mv "$FPK_FILE" "/tmp/cloudreve-packages/$FPK_NAME"
            
            # è®°å½•äº§ç‰©è·¯å¾„
            RELEASE_FILES+="/tmp/cloudreve-packages/$FPK_NAME "
            echo "âœ… $ARCH æ‰“åŒ…å®Œæˆï¼š/tmp/cloudreve-packages/$FPK_NAME"

            # è°ƒè¯•æ¨¡å¼ï¼šè¾“å‡ºæ–‡ä»¶è¯¦æƒ…
            if [ "$DEBUG_MODE" = "true" ]; then
              echo "===== è°ƒè¯•ï¼š$ARCH äº§ç‰©ä¿¡æ¯ ====="
              ls -lh "/tmp/cloudreve-packages/$FPK_NAME"
              sha256sum "/tmp/cloudreve-packages/$FPK_NAME"
              echo "=============================="
            fi
          done

          # è¾“å‡ºäº§ç‰©åˆ—è¡¨
          echo -e "\nâœ… æ‰€æœ‰æ¶æ„æ‰“åŒ…å®Œæˆï¼Œäº§ç‰©åˆ—è¡¨ï¼š"
          ls -lh /tmp/cloudreve-packages/
          
          # ä¼ é€’äº§ç‰©è·¯å¾„ç»™åç»­æ­¥éª¤
          echo "release_files=$RELEASE_FILES" >> $GITHUB_OUTPUT
          echo "package_dir=/tmp/cloudreve-packages" >> $GITHUB_OUTPUT

      # ===================== ç¬¬å››æ­¥ï¼šè°ƒè¯•/ç”Ÿäº§æ¨¡å¼åˆ†æ”¯ =====================
      - name: 9. ç”Ÿäº§æ¨¡å¼ï¼šæ¨é€äº§ç‰©åˆ°FnDepotä»“åº“
        if: steps.compare.outputs.need_update == 'true' && env.DEBUG_MODE == 'false'
        run: |
          # å…‹éš†FnDepotä»“åº“
          git clone https://${{ secrets.FnDepot_PAT }}@github.com/moxyis/FnDepot.git /tmp/FnDepot
          
          # å¤åˆ¶äº§ç‰©åˆ°å¯¹åº”ç›®å½•
          mkdir -p /tmp/FnDepot/fpk-cloudreve/x86 /tmp/FnDepot/fpk-cloudreve/arm
          cp /tmp/cloudreve-packages/fpk-cloudreve-x86-* /tmp/FnDepot/fpk-cloudreve/x86/
          cp /tmp/cloudreve-packages/fpk-cloudreve-arm-* /tmp/FnDepot/fpk-cloudreve/arm/
          
          # æ›´æ–°ç‰ˆæœ¬é…ç½®
          cd /tmp/FnDepot
          jq --arg ver "${{ steps.remote_version.outputs.remote_version }}" \
            '.["fpk-cloudreve"] = {"x86": {"version": $ver}, "arm": {"version": $ver}}' \
            fnpack.json > fnpack.tmp && mv fnpack.tmp fnpack.json
          
          # æäº¤å¹¶æ¨é€
          git add fpk-cloudreve/ fnpack.json
          git commit -m "chore: æ›´æ–°Cloudreveå¤šæ¶æ„ç‰ˆæœ¬è‡³${{ steps.remote_version.outputs.remote_version }}" || echo "æ— å˜æ›´"
          git push origin main
          echo "âœ… äº§ç‰©å·²æ¨é€åˆ°FnDepotä»“åº“"

      - name: 10. è°ƒè¯•æ¨¡å¼ï¼šä»…è¾“å‡ºäº§ç‰©ä¿¡æ¯ï¼ˆç¦ç”¨æ¨é€ï¼‰
        if: steps.compare.outputs.need_update == 'true' && env.DEBUG_MODE == 'true'
        run: |
          echo -e "\nâš ï¸ è°ƒè¯•æ¨¡å¼ï¼šæ‰€æœ‰æ¨é€æ“ä½œå·²ç¦ç”¨"
          echo "===== æœ€ç»ˆäº§ç‰©æ¸…å• ====="
          ls -lh ${{ steps.build_packages.outputs.package_dir }}
          echo "========================"
          echo "âœ… è°ƒè¯•å®Œæˆï¼Œäº§ç‰©å­˜å‚¨è·¯å¾„ï¼š${{ steps.build_packages.outputs.package_dir }}"

      - name: 11. ç”Ÿäº§æ¨¡å¼ï¼šåˆ›å»ºGitHub Release
        if: steps.compare.outputs.need_update == 'true' && env.DEBUG_MODE == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "cloudreve-v${{ steps.remote_version.outputs.remote_version }}"
          name: "Cloudreve v${{ steps.remote_version.outputs.remote_version }}ï¼ˆå¤šæ¶æ„ï¼‰"
          body: |
            ## Cloudreve å¤šæ¶æ„è‡ªåŠ¨æ‰“åŒ…
            - ç‰ˆæœ¬ï¼šv${{ steps.remote_version.outputs.remote_version }}
            - æ”¯æŒæ¶æ„ï¼šx86 / arm
            - æ‰“åŒ…æ—¶é—´ï¼š${{ github.run_at }}
            - æ‰“åŒ…å·¥å…·ï¼šfnpack 1.2.0
          files: ${{ steps.build_packages.outputs.release_files }}
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ===================== ç¬¬äº”æ­¥ï¼šæ›´æ–°åŸºç¡€manifestç‰ˆæœ¬å· =====================
      - name: 12. æ›´æ–°åŸºç¡€manifestç‰ˆæœ¬å·
        if: steps.compare.outputs.need_update == 'true'
        run: |
          # æ›´æ–°åŸºç¡€manifestçš„ç‰ˆæœ¬å·
          sed -i -E \
            "s/(^[[:space:]]*version[[:space:]]*[:=][[:space:]]*)([\"']?)(.+)([\"']?)/\1\2${{ steps.remote_version.outputs.remote_version }}\4/" \
            Cloudreve/manifest
          
          # ç”Ÿäº§æ¨¡å¼æ¨é€ï¼Œè°ƒè¯•æ¨¡å¼ä»…æš‚å­˜
          git add Cloudreve/manifest
          if [ "$DEBUG_MODE" = "false" ]; then
            git commit -m "chore: æ›´æ–°åŸºç¡€ç‰ˆæœ¬å·è‡³${{ steps.remote_version.outputs.remote_version }}"
            git push origin HEAD:${{ github.ref_name }}
            echo "âœ… åŸºç¡€manifestç‰ˆæœ¬å·å·²æ¨é€"
          else
            echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šåŸºç¡€manifestå·²æ›´æ–°ï¼Œä»…æœ¬åœ°æš‚å­˜æœªæ¨é€"
          fi
