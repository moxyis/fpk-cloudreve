name: è‡ªåŠ¨æ‰“åŒ…Cloudreveå¹¶åŒæ­¥æ›´æ–°

on:
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'è°ƒè¯•æ¨¡å¼ï¼ˆtrue=ä»…æ‰“åŒ…ä¸æ¨é€ï¼‰'
        required: true
        default: 'false'
        type: boolean
  schedule:
    - cron: '0 0 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      - name: 1. æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤2ï¼šé…ç½®Gitèº«ä»½
      - name: 2. é…ç½®Gitå…¨å±€ä¿¡æ¯
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          echo "ğŸ” è°ƒè¯•æ¨¡å¼: ${{ github.event.inputs.debug_mode || 'false' }}"
          echo "debug_mode=${{ github.event.inputs.debug_mode || 'false' }}" >> $GITHUB_ENV

      # æ­¥éª¤3ï¼šå®‰è£…åŸºç¡€ä¾èµ–
      - name: 3. å®‰è£…jq/curl/sedä¾èµ–
        run: |
          sudo apt update && sudo apt install -y jq curl sed
          echo "âœ… åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆ"

      # æ­¥éª¤4ï¼šè¯»å–æœ¬åœ°manifestç‰ˆæœ¬
      - name: 4. è¯»å–æœ¬åœ°ç‰ˆæœ¬å·
        id: local_ver
        run: |
          MANIFEST_FILE="Cloudreve/manifest"
          if [ -f "$MANIFEST_FILE" ]; then
            LOCAL_VERSION=$(sed -n 's/^version[[:space:]]*:[[:space:]]*//p' "$MANIFEST_FILE" | tr -d '"' | sed 's/^v//' | xargs)
            echo "æœ¬åœ°ç‰ˆæœ¬: $LOCAL_VERSION"
            echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æœªæ‰¾åˆ°manifestï¼Œé»˜è®¤ç‰ˆæœ¬0.0.0"
            echo "local_version=0.0.0" >> $GITHUB_OUTPUT
            mkdir -p Cloudreve && echo "version: 0.0.0" > "$MANIFEST_FILE"
            [ "$DEBUG_MODE" = "false" ] && git add "$MANIFEST_FILE" && git commit -m "åˆå§‹åŒ–manifest" || echo "è°ƒè¯•æ¨¡å¼è·³è¿‡æäº¤"
          fi
        env:
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}

      # æ­¥éª¤5ï¼šè·å–Cloudreveæœ€æ–°ç‰ˆæœ¬
      - name: 5. è·å–å®˜æ–¹æœ€æ–°ç‰ˆæœ¬
        id: remote_ver
        run: |
          REMOTE_VERSION=$(curl -sSL --retry 3 --connect-timeout 10 \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/cloudreve/Cloudreve/releases/latest \
            | jq -r '.tag_name' | sed 's/^v//' | xargs)
          
          if [ -z "$REMOTE_VERSION" ] || [ "$REMOTE_VERSION" = "null" ]; then
            echo "âŒ è·å–è¿œç¨‹ç‰ˆæœ¬å¤±è´¥"
            exit 1
          fi
          
          echo "å®˜æ–¹æœ€æ–°ç‰ˆæœ¬: $REMOTE_VERSION"
          echo "remote_version=$REMOTE_VERSION" >> $GITHUB_OUTPUT
          echo "arch_mapping=Linux-AMD64:x86,Linux-ARM64:arm" >> $GITHUB_OUTPUT

      # æ­¥éª¤6ï¼šç‰ˆæœ¬æ¯”å¯¹
      - name: 6. ç‰ˆæœ¬æ¯”å¯¹åˆ¤æ–­æ˜¯å¦æ›´æ–°
        id: compare
        run: |
          if [ "${{ steps.local_ver.outputs.local_version }}" = "${{ steps.remote_ver.outputs.remote_version }}" ]; then
            echo "âœ… ç‰ˆæœ¬ä¸€è‡´ï¼Œæ— éœ€æ›´æ–°"
            echo "need_update=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå¼€å§‹æ‰“åŒ…"
            echo "need_update=true" >> $GITHUB_OUTPUT
          fi

      # æ­¥éª¤7ï¼šå®‰è£…fnpack 1.2.0
      - name: 7. å®‰è£…fnpackæœ€æ–°ç‰ˆ
        if: steps.compare.outputs.need_update == 'true'
        run: |
          FNPACK_URL="https://static2.fnnas.com/fnpack/fnpack-1.2.0-linux-amd64"
          curl -SL --retry 3 --connect-timeout 10 -o /usr/local/bin/fnpack "$FNPACK_URL"
          chmod +x /usr/local/bin/fnpack
          
          if ! command -v fnpack &>/dev/null; then
            echo "âŒ fnpackå®‰è£…å¤±è´¥"
            exit 1
          fi
          echo "âœ… fnpack 1.2.0 å®‰è£…æˆåŠŸ: $(which fnpack)"
          fnpack version

      # æ­¥éª¤8ï¼šå¤šæ¶æ„æ‰“åŒ…ï¼ˆæ ¸å¿ƒï¼šæ— EOFï¼Œæ— ç¼©è¿›å†²çªï¼‰
      - name: 8. å¤šæ¶æ„æ‰“åŒ…ç”ŸæˆFPK
        if: steps.compare.outputs.need_update == 'true'
        id: build_multi_arch
        run: |
          set -euo pipefail
          IFS=',' read -ra ARCH_MAP_LIST <<< "${{ steps.remote_ver.outputs.arch_mapping }}"
          REMOTE_VERSION="${{ steps.remote_ver.outputs.remote_version }}"
          
          [ -z "$REMOTE_VERSION" ] && echo "âŒ ç‰ˆæœ¬å·ä¸ºç©º" && exit 1
          
          RELEASE_FILES=""
          FNDEPOT_FPK_PATHS=""

          for ARCH_MAP in "${ARCH_MAP_LIST[@]}"; do
            IFS=':' read -r OFFICIAL_ARCH PLATFORM_VAL <<< "$ARCH_MAP"
            [ -z "$PLATFORM_VAL" ] && echo "âš ï¸ è·³è¿‡ç©ºplatformå€¼çš„æ¶æ„" && continue
            
            echo "========================================"
            echo "ğŸš€ å¤„ç†æ¶æ„: $OFFICIAL_ARCH -> $PLATFORM_VAL"
            echo "========================================"
            
            case $OFFICIAL_ARCH in
              Linux-AMD64) ARCH_KEY="linux_amd64"; ARCH_SHORT="amd64" ;;
              Linux-ARM64) ARCH_KEY="linux_arm64"; ARCH_SHORT="arm64" ;;
              *) echo "âŒ ä¸æ”¯æŒçš„æ¶æ„: $OFFICIAL_ARCH"; exit 1 ;;
            esac
            
            RELEASE_DATA=$(curl -sSL --retry 3 -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/cloudreve/Cloudreve/releases/latest)
            DOWNLOAD_URL=$(echo "$RELEASE_DATA" | jq -r \
              '.assets[] | select(.name | contains("'$ARCH_KEY'.tar.gz")) | .browser_download_url' | head -n1)
            
            [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ] && echo "âŒ æœªæ‰¾åˆ°ä¸‹è½½é“¾æ¥" && exit 1
            echo "âœ… ä¸‹è½½é“¾æ¥: $DOWNLOAD_URL"
            
            ARCH_DIR="Cloudreve_$ARCH_SHORT"
            mkdir -p $ARCH_DIR/app/bin
            curl -SL --retry 3 -o /tmp/cloudreve_$ARCH_SHORT.tar.gz "$DOWNLOAD_URL"
            
            tar -zxf /tmp/cloudreve_$ARCH_SHORT.tar.gz -C /tmp
            [ ! -f "/tmp/cloudreve" ] && echo "âŒ è§£å‹æ— äºŒè¿›åˆ¶æ–‡ä»¶" && exit 1
            
            mv /tmp/cloudreve $ARCH_DIR/app/bin/
            chmod +x $ARCH_DIR/app/bin/cloudreve
            rm -rf /tmp/cloudreve_$ARCH_SHORT.tar.gz /tmp/cloudreve
            
            # å•è¡Œç”Ÿæˆmanifestï¼Œæ— EOFå†²çª
            echo -e "version: $REMOTE_VERSION\nplatform: $PLATFORM_VAL" > $ARCH_DIR/manifest
            echo "âœ… ç”ŸæˆmanifestæˆåŠŸ"
            cat $ARCH_DIR/manifest
            
            cd $ARCH_DIR
            echo "ğŸš€ æ‰§è¡Œfnpack build"
            fnpack build
            
            FPK_FILE=$(find . -name "*.fpk" -type f | head -n1)
            [ -z "$FPK_FILE" ] && echo "âŒ æœªç”ŸæˆFPKæ–‡ä»¶" && exit 1
            
            FPK_VERSION_NAME="fpk-cloudreve-v$REMOTE_VERSION-$PLATFORM_VAL.fpk"
            FPK_FULL_PATH="/tmp/$FPK_VERSION_NAME"
            mv $FPK_FILE $FPK_FULL_PATH
            
            RELEASE_FILES+="$FPK_FULL_PATH "
            FNDEPOT_FPK_PATHS+="$FPK_FULL_PATH:$PLATFORM_VAL "
            
            echo "âœ… æ‰“åŒ…å®Œæˆ: $FPK_FULL_PATH"
            cd -
          done
          
          echo "release_files=$RELEASE_FILES" >> $GITHUB_OUTPUT
          echo "fndepot_fpk_paths=$FNDEPOT_FPK_PATHS" >> $GITHUB_OUTPUT
          echo "âœ… æ‰€æœ‰æ¶æ„æ‰“åŒ…å®Œæˆ"

      # æ­¥éª¤9ï¼šæ›´æ–°æœ¬åœ°manifestç‰ˆæœ¬
      - name: 9. æ›´æ–°æœ¬åœ°manifestç‰ˆæœ¬
        if: steps.compare.outputs.need_update == 'true'
        run: |
          MANIFEST_FILE="Cloudreve/manifest"
          sed -i -E "s/^version[[:space:]]*:[[:space:]]*.*/version: ${{ steps.remote_ver.outputs.remote_version }}/" "$MANIFEST_FILE"
          echo "âœ… ä¸»manifestç‰ˆæœ¬æ›´æ–°ä¸º: ${{ steps.remote_ver.outputs.remote_version }}"
          cat "$MANIFEST_FILE" | grep version
          git add "$MANIFEST_FILE"

      # æ­¥éª¤10ï¼šæ¨é€manifest
      - name: 10. æ¨é€manifeståˆ°ä»“åº“
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode != 'true'
        run: |
          git commit -m "chore: æ›´æ–°Cloudreveè‡³v${{ steps.remote_ver.outputs.remote_version }}" || echo "âœ… æ— å˜æ›´éœ€æäº¤"
          git push origin HEAD:${{ github.ref_name }}
          echo "âœ… manifestå·²æ¨é€"

      # æ­¥éª¤10.1ï¼šè°ƒè¯•æ¨¡å¼è·³è¿‡æ¨é€
      - name: 10.1 è°ƒè¯•æ¨¡å¼-è·³è¿‡manifestæ¨é€
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode == 'true'
        run: echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡manifestæ¨é€"

      # æ­¥éª¤11ï¼šå…‹éš†FnDepotä»“åº“
      - name: 11. å…‹éš†FnDepotä»“åº“
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode != 'true'
        run: |
          git clone https://${{ secrets.FnDepot_PAT }}@github.com/moxyis/FnDepot.git /tmp/FnDepot
          echo "âœ… FnDepotä»“åº“å…‹éš†å®Œæˆ"

      # æ­¥éª¤11.1ï¼šè°ƒè¯•æ¨¡å¼è·³è¿‡å…‹éš†
      - name: 11.1 è°ƒè¯•æ¨¡å¼-è·³è¿‡FnDepotå…‹éš†
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode == 'true'
        run: echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡FnDepotå…‹éš†"

      # æ­¥éª¤12ï¼šå¤åˆ¶FPKåˆ°FnDepot
      - name: 12. å¤åˆ¶FPKåˆ°FnDepot
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode != 'true'
        run: |
          IFS=' ' read -ra FPK_PATH_LIST <<< "${{ steps.build_multi_arch.outputs.fndepot_fpk_paths }}"
          for FPK_PATH_MAP in "${FPK_PATH_LIST[@]}"; do
            [ -z "$FPK_PATH_MAP" ] && continue
            IFS=':' read -r FPK_FILE PLATFORM_VAL <<< "$FPK_PATH_MAP"
            FNDIR="/tmp/FnDepot/fpk-cloudreve/$PLATFORM_VAL"
            mkdir -p "$FNDIR"
            rm -f "$FNDIR/fpk-cloudreve.fpk"
            cp "$FPK_FILE" "$FNDIR/fpk-cloudreve.fpk"
            echo "âœ… å¤åˆ¶$PLATFORM_VALæ¶æ„FPKå®Œæˆ"
          done

      # æ­¥éª¤12.1ï¼šè°ƒè¯•æ¨¡å¼è·³è¿‡å¤åˆ¶
      - name: 12.1 è°ƒè¯•æ¨¡å¼-è·³è¿‡æ–‡ä»¶å¤åˆ¶
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode == 'true'
        run: echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡FPKæ–‡ä»¶å¤åˆ¶"

      # æ­¥éª¤13ï¼šæ›´æ–°fnpack.json
      - name: 13. æ›´æ–°FnDepotçš„fnpack.json
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode != 'true'
        run: |
          cd /tmp/FnDepot
          REMOTE_VERSION="${{ steps.remote_ver.outputs.remote_version }}"
          
          [ ! -f "fnpack.json" ] && echo '{
  "fpk-cloudreve": {
    "version": "",
    "architectures": {
      "x86": "",
      "arm": ""
    }
  }
}' > fnpack.json
          
          jq --arg ver "$REMOTE_VERSION" \
             '.["fpk-cloudreve"].version = $ver 
             | .["fpk-cloudreve"].architectures.x86 = $ver 
             | .["fpk-cloudreve"].architectures.arm = $ver' \
             fnpack.json > fnpack.tmp && mv fnpack.tmp fnpack.json
          
          echo "âœ… fnpack.jsonæ›´æ–°å®Œæˆ"
          cat fnpack.json

      # æ­¥éª¤13.1ï¼šè°ƒè¯•æ¨¡å¼è·³è¿‡æ›´æ–°
      - name: 13.1 è°ƒè¯•æ¨¡å¼-è·³è¿‡jsonæ›´æ–°
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode == 'true'
        run: echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡fnpack.jsonæ›´æ–°"

      # æ­¥éª¤14ï¼šæ›´æ–°README.md
      - name: 14. æ›´æ–°FnDepotçš„README.md
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode != 'true'
        run: |
          cd /tmp/FnDepot
          REMOTE_VERSION="${{ steps.remote_ver.outputs.remote_version }}"
          
          if [ ! -f "README.md" ]; then
            echo "# FnDepot
| **åº”ç”¨** | **ç‰ˆæœ¬** | **x86å¹³å°** | **armå¹³å°** | **é“¾æ¥** |
|----------|----------|-------------|-------------|----------|
| **Cloudreve** | $REMOTE_VERSION | âœ… æ”¯æŒ | âœ… æ”¯æŒ | https://cloudreve.org/ |

### è¯´æ˜
- æ‰“åŒ…å·¥å…·ï¼šfnpack 1.2.0
- platformæ˜ å°„ï¼šx86=AMD64ï¼Œarm=ARM64
- è‡ªåŠ¨æ›´æ–°å‘¨æœŸï¼šæ¯æ—¥å‡Œæ™¨" > README.md
          else
            sed -i -E "s/(\|\s*\*\*Cloudreve\*\*\s*\|\s*)[0-9.]+\s*(\|\s*âœ… æ”¯æŒ\s*\|\s*âœ… æ”¯æŒ\s*\|\s*https:\/\/cloudreve.org\/\s*\|)/\1$REMOTE_VERSION\2/g" README.md
          fi
          
          echo "âœ… README.mdæ›´æ–°å®Œæˆ"
          grep -A 2 -B 1 "Cloudreve" README.md

      # æ­¥éª¤14.1ï¼šè°ƒè¯•æ¨¡å¼è·³è¿‡æ›´æ–°
      - name: 14.1 è°ƒè¯•æ¨¡å¼-è·³è¿‡READMEæ›´æ–°
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode == 'true'
        run: echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡README.mdæ›´æ–°"

      # æ­¥éª¤15ï¼šæ¨é€FnDepotå˜æ›´
      - name: 15. æ¨é€FnDepotå˜æ›´
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode != 'true'
        run: |
          cd /tmp/FnDepot
          git add fpk-cloudreve/ fnpack.json README.md
          git commit -m "chore: æ›´æ–°Cloudreveè‡³v${{ steps.remote_ver.outputs.remote_version }}" || echo "âœ… æ— å˜æ›´éœ€æäº¤"
          git push origin main
          echo "âœ… FnDepotå˜æ›´å·²æ¨é€"

      # æ­¥éª¤15.1ï¼šè°ƒè¯•æ¨¡å¼è·³è¿‡æ¨é€
      - name: 15.1 è°ƒè¯•æ¨¡å¼-è·³è¿‡FnDepotæ¨é€
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode == 'true'
        run: echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡FnDepotæ¨é€"

      # æ­¥éª¤16ï¼šåˆ›å»ºRelease
      - name: 16. åˆ›å»ºReleaseå¹¶ä¸Šä¼ FPK
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "cloudreve-v${{ steps.remote_ver.outputs.remote_version }}"
          name: "Cloudreve v${{ steps.remote_ver.outputs.remote_version }}"
          body: |
            ## Cloudreve è‡ªåŠ¨æ‰“åŒ…æ›´æ–°
            - ç‰ˆæœ¬ï¼šv${{ steps.remote_ver.outputs.remote_version }}
            - æ¶æ„ï¼šx86(AMD64)ã€arm(ARM64)
            - æ‰“åŒ…å·¥å…·ï¼šfnpack 1.2.0
            - FnDepotä»“åº“ï¼šhttps://github.com/moxyis/FnDepot/tree/main/fpk-cloudreve
          prerelease: false
          files: ${{ steps.build_multi_arch.outputs.release_files }}
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤16.1ï¼šè°ƒè¯•æ¨¡å¼è·³è¿‡Release
      - name: 16.1 è°ƒè¯•æ¨¡å¼-è·³è¿‡Releaseåˆ›å»º
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode == 'true'
        run: echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡Releaseåˆ›å»ºï¼Œå¾…ä¸Šä¼ æ–‡ä»¶ï¼š${{ steps.build_multi_arch.outputs.release_files }}"
