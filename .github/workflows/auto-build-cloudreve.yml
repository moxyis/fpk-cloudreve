name: ç‰ˆæœ¬æ¯”å¯¹åè‡ªåŠ¨æ‰“åŒ…Cloudreve

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥UTC 0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰è‡ªåŠ¨æ£€æµ‹

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      # ===================== ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡ =====================
      - name: 1. æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: 2. å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆjq/curl/sedï¼‰
        run: |
          sudo apt update && sudo apt install -y jq curl sed
          echo "åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆ"

      # ===================== ç¬¬äºŒæ­¥ï¼šç‰ˆæœ¬æ¯”å¯¹ï¼ˆæ ¸å¿ƒå‰ç½®ï¼‰ =====================
      - name: 3. è¯»å–æœ¬åœ°manifestç‰ˆæœ¬å·
        id: local_ver
        run: |
          if [ -f "cloudreve/manifest" ]; then
            # æå–versionå­—æ®µï¼ˆå…¼å®¹å¤šæ ¼å¼ï¼Œå»é™¤vå‰ç¼€/å¼•å·ï¼‰
            LOCAL_VERSION=$(sed -n 's/^[[:space:]]*version[[:space:]]*[:=][[:space:]]*//p' cloudreve/manifest \
              | tr -d '"' | tr -d "'" | sed 's/^v//' | xargs)
            echo "æœ¬åœ°manifestç‰ˆæœ¬ï¼š$LOCAL_VERSION"
            echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT
          else
            echo "âŒ æœªæ‰¾åˆ°cloudreve/manifestï¼Œå¼ºåˆ¶è§¦å‘æ›´æ–°"
            echo "local_version=0.0.0" >> $GITHUB_OUTPUT
          fi

      - name: 4. è·å–Cloudreveå®˜æ–¹æœ€æ–°æ­£å¼ç‰ˆç‰ˆæœ¬å·
        id: remote_ver
        run: |
          # ä»…è·å–ç‰ˆæœ¬å·ï¼ˆè½»é‡è¯·æ±‚ï¼‰
          REMOTE_VERSION=$(curl -sSL -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/cloudreve/Cloudreve/releases/latest" \
            | jq -r '.tag_name' | sed 's/^v//' | xargs)
          
          if [ -z "$REMOTE_VERSION" ] || [ "$REMOTE_VERSION" = "null" ]; then
            echo "âŒ è·å–è¿œç¨‹ç‰ˆæœ¬å¤±è´¥"
            exit 1
          fi
          
          echo "è¿œç¨‹æœ€æ–°ç‰ˆæœ¬ï¼š$REMOTE_VERSION"
          echo "remote_version=$REMOTE_VERSION" >> $GITHUB_OUTPUT

      - name: 5. ç‰ˆæœ¬æ¯”å¯¹ï¼Œåˆ¤æ–­æ˜¯å¦æ›´æ–°
        id: compare
        run: |
          if [ "${{ steps.local_ver.outputs.local_version }}" = "${{ steps.remote_ver.outputs.remote_version }}" ]; then
            echo "âœ… æœ¬åœ°ç‰ˆæœ¬ä¸è¿œç¨‹ç‰ˆæœ¬ä¸€è‡´ï¼ˆ${{ steps.remote_ver.outputs.remote_version }}ï¼‰ï¼Œæ— éœ€æ›´æ–°"
            echo "need_update=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå¼€å§‹æ›´æ–°æ‰“åŒ…æµç¨‹"
            echo "need_update=true" >> $GITHUB_OUTPUT
          fi

      # ===================== ç¬¬ä¸‰æ­¥ï¼šä»…ç‰ˆæœ¬ä¸ä¸€è‡´æ—¶æ‰§è¡Œ =====================
      - name: 6. ä¸‹è½½Cloudreveæœ€æ–°Linux AMD64äºŒè¿›åˆ¶æ–‡ä»¶
        if: steps.compare.outputs.need_update == 'true'
        id: download_cloudreve
        run: |
          # è·å–å®Œæ•´å‘è¡Œç‰ˆæ•°æ®ï¼Œç­›é€‰Linux AMD64ä¸‹è½½é“¾æ¥
          RELEASE_DATA=$(curl -sSL -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/cloudreve/Cloudreve/releases/latest")
          
          DOWNLOAD_URL=$(echo "$RELEASE_DATA" | jq -r --arg filter "*linux-amd64.tar.gz" \
            '.assets[] | select(.name | test($filter | gsub("\\*"; ".*"); "i")) | .browser_download_url')
          
          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
            echo "âŒ æœªæ‰¾åˆ°Linux AMD64ç‰ˆæœ¬ä¸‹è½½é“¾æ¥"
            exit 1
          fi
          
          # åˆ›å»ºç›®å½•å¹¶ä¸‹è½½è§£å‹
          mkdir -p cloudreve/app/bin
          curl -SL -o /tmp/cloudreve.tar.gz "$DOWNLOAD_URL"
          tar -zxf /tmp/cloudreve.tar.gz -C /tmp
          mv /tmp/cloudreve cloudreve/app/bin/
          chmod +x cloudreve/app/bin/cloudreve
          rm -rf /tmp/cloudreve.tar.gz /tmp/cloudreve
          echo "âœ… CloudreveäºŒè¿›åˆ¶æ–‡ä»¶å·²ä¸‹è½½è‡³cloudreve/app/bin/"

      - name: 7. æ›´æ–°manifestçš„versionå­—æ®µ
        if: steps.compare.outputs.need_update == 'true'
        run: |
          # å…¼å®¹å¤šæ ¼å¼æ›´æ–°version
          sed -i -E \
            "s/(^[[:space:]]*version[[:space:]]*[:=][[:space:]]*)([\"']?)([0-9a-zA-Z.]+)([\"']?)/\1\2${{ steps.remote_ver.outputs.remote_version }}\4/" \
            cloudreve/manifest
          
          echo "âœ… manifestç‰ˆæœ¬å·²æ›´æ–°ä¸ºï¼š${{ steps.remote_ver.outputs.remote_version }}"
          cat cloudreve/manifest | grep -i version

      - name: 8. ä¸‹è½½å¹¶å®‰è£…fnpackï¼ˆæŒ‡å®šåœ°å€ï¼‰
        if: steps.compare.outputs.need_update == 'true'
        run: |
          # ä¸‹è½½fnpack-1.0.4-linux-amd64
          FNPACK_URL="https://static2.fnnas.com/fnpack/fnpack-1.0.4-linux-amd64"
          curl -SL -o /usr/local/bin/fnpack "$FNPACK_URL"
          # æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x /usr/local/bin/fnpack
          # éªŒè¯å®‰è£…
          fnpack --version || { echo "âŒ fnpackå®‰è£…å¤±è´¥"; exit 1; }
          echo "âœ… fnpackå®‰è£…å®Œæˆï¼Œç‰ˆæœ¬ï¼š$(fnpack --version 2>/dev/null || echo "1.0.4")"

      - name: 9. æ‰§è¡Œfnpackæ‰“åŒ…
        if: steps.compare.outputs.need_update == 'true'
        run: |
          # è¿›å…¥åº”ç”¨ç›®å½•ï¼ŒæŒ‡å®šæ‰“åŒ…ç›®å½•ä¸ºcloudreve/app
          cd cloudreve
          fnpack build --directory app
          echo "âœ… fnpackæ‰“åŒ…å®Œæˆ"

      # ===================== å¯é€‰ï¼šä¸Šä¼ æ‰“åŒ…äº§ç‰© =====================
      - name: 10. ä¸Šä¼ æ‰“åŒ…äº§ç‰©
        if: steps.compare.outputs.need_update == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: cloudreve-build-${{ steps.remote_ver.outputs.remote_version }}
          path: cloudreve/
          retention-days: 7
