name: ç‰ˆæœ¬æ¯”å¯¹åè‡ªåŠ¨æ‰“åŒ…Cloudreve

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥UTC 0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰è‡ªåŠ¨æ£€æµ‹

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      # ===================== ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡ =====================
      - name: 1. æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: 2. å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆjq/curl/sedï¼‰
        run: |
          sudo apt update && sudo apt install -y jq curl sed
          echo "åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆ"

      # ===================== ç¬¬äºŒæ­¥ï¼šç‰ˆæœ¬æ¯”å¯¹ï¼ˆæ ¸å¿ƒå‰ç½®ï¼‰ =====================
      - name: 3. è¯»å–æœ¬åœ°manifestç‰ˆæœ¬å·
        id: local_ver
        run: |
          if [ -f "cloudreve/manifest" ]; then
            LOCAL_VERSION=$(sed -n 's/^[[:space:]]*version[[:space:]]*[:=][[:space:]]*//p' cloudreve/manifest \
              | tr -d '"' | tr -d "'" | sed 's/^v//' | xargs)
            echo "æœ¬åœ°manifestç‰ˆæœ¬ï¼š$LOCAL_VERSION"
            echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT
          else
            echo "âŒ æœªæ‰¾åˆ°cloudreve/manifestï¼Œå¼ºåˆ¶è§¦å‘æ›´æ–°"
            echo "local_version=0.0.0" >> $GITHUB_OUTPUT
          fi

      - name: 4. è·å–Cloudreveå®˜æ–¹æœ€æ–°æ­£å¼ç‰ˆç‰ˆæœ¬å·
        id: remote_ver
        run: |
          REMOTE_VERSION=$(curl -sSL --retry 3 --connect-timeout 10 \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/cloudreve/Cloudreve/releases/latest" \
            | jq -r '.tag_name' | sed 's/^v//' | xargs)
          
          if [ -z "$REMOTE_VERSION" ] || [ "$REMOTE_VERSION" = "null" ]; then
            echo "âŒ è·å–è¿œç¨‹ç‰ˆæœ¬å¤±è´¥"
            exit 1
          fi
          
          echo "è¿œç¨‹æœ€æ–°ç‰ˆæœ¬ï¼š$REMOTE_VERSION"
          echo "remote_version=$REMOTE_VERSION" >> $GITHUB_OUTPUT

      - name: 5. ç‰ˆæœ¬æ¯”å¯¹ï¼Œåˆ¤æ–­æ˜¯å¦æ›´æ–°
        id: compare
        run: |
          if [ "${{ steps.local_ver.outputs.local_version }}" = "${{ steps.remote_ver.outputs.remote_version }}" ]; then
            echo "âœ… æœ¬åœ°ç‰ˆæœ¬ä¸è¿œç¨‹ç‰ˆæœ¬ä¸€è‡´ï¼ˆ${{ steps.remote_ver.outputs.remote_version }}ï¼‰ï¼Œæ— éœ€æ›´æ–°"
            echo "need_update=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå¼€å§‹æ›´æ–°æ‰“åŒ…æµç¨‹"
            echo "need_update=true" >> $GITHUB_OUTPUT
          fi

      # ===================== ç¬¬ä¸‰æ­¥ï¼šä»…ç‰ˆæœ¬ä¸ä¸€è‡´æ—¶æ‰§è¡Œ =====================
      - name: 6. ä¸‹è½½Cloudreve Linux AMD64ç‰ˆæœ¬ï¼ˆæç®€åŒ¹é…ï¼‰
        if: steps.compare.outputs.need_update == 'true'
        id: download_cloudreve
        run: |
          set -euo pipefail
          
          # 1. è·å–å®Œæ•´å‘è¡Œç‰ˆæ•°æ®
          RELEASE_DATA=$(curl -sSL --retry 3 --connect-timeout 10 \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/cloudreve/Cloudreve/releases/latest")
          
          # 2. è°ƒè¯•ï¼šè¾“å‡ºæ‰€æœ‰èµ„äº§åç§°
          echo "ğŸ“œ è¿œç¨‹å‘è¡Œç‰ˆæ‰€æœ‰èµ„äº§åç§°ï¼š"
          echo "$RELEASE_DATA" | jq -r '.assets[].name'
          
          # 3. æç®€åŒ¹é…ï¼šç›´æ¥ç­›é€‰åŒ…å« "linux_amd64.tar.gz" çš„èµ„äº§ï¼ˆç»•å¼€æ­£åˆ™æ‹¼æ¥å‘ï¼‰
          DOWNLOAD_URL=$(echo "$RELEASE_DATA" | jq -r \
            '.assets[] | select(.name | contains("linux_amd64.tar.gz")) | .browser_download_url' | head -n1)
          
          # 4. æœ€ç»ˆæ ¡éªŒï¼ˆæ˜ç¡®æç¤ºï¼‰
          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
            echo "âŒ æœªæ‰¾åˆ°åŒ…å« 'linux_amd64.tar.gz' çš„èµ„äº§"
            exit 1
          fi
          
          # 5. æå–åŒ¹é…åˆ°çš„èµ„äº§å
          MATCHED_ASSET=$(echo "$RELEASE_DATA" | jq -r '.assets[] | select(.name | contains("linux_amd64.tar.gz")) | .name' | head -n1)
          echo "âœ… åŒ¹é…åˆ°ç›®æ ‡èµ„äº§ï¼š$MATCHED_ASSET"
          echo "âœ… ä¸‹è½½é“¾æ¥ï¼š$DOWNLOAD_URL"
          
          # 6. åˆ›å»ºç›®å½•å¹¶ä¸‹è½½
          mkdir -p cloudreve/app/bin
          curl -SL --retry 3 --connect-timeout 10 -o /tmp/cloudreve.tar.gz "$DOWNLOAD_URL"
          
          # 7. è§£å‹å¹¶éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶
          tar -zxf /tmp/cloudreve.tar.gz -C /tmp
          if [ ! -f "/tmp/cloudreve" ]; then
            echo "âŒ è§£å‹åæœªæ‰¾åˆ°cloudreveäºŒè¿›åˆ¶æ–‡ä»¶"
            exit 1
          fi
          
          # 8. ç§»åŠ¨æ–‡ä»¶+æ·»åŠ æ‰§è¡Œæƒé™
          mv /tmp/cloudreve cloudreve/app/bin/
          chmod +x cloudreve/app/bin/cloudreve
          rm -rf /tmp/cloudreve.tar.gz /tmp/cloudreve
          
          # 9. éªŒè¯æ–‡ä»¶ä¿¡æ¯
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶ä¿¡æ¯ï¼š"
          ls -lh cloudreve/app/bin/cloudreve
          file cloudreve/app/bin/cloudreve

      - name: 7. æ›´æ–°manifestçš„versionå­—æ®µ
        if: steps.compare.outputs.need_update == 'true'
        run: |
          sed -i -E \
            "s/(^[[:space:]]*version[[:space:]]*[:=][[:space:]]*)([\"']?)([0-9a-zA-Z.]+)([\"']?)/\1\2${{ steps.remote_ver.outputs.remote_version }}\4/" \
            cloudreve/manifest
          
          echo "âœ… manifestç‰ˆæœ¬å·²æ›´æ–°ä¸ºï¼š${{ steps.remote_ver.outputs.remote_version }}"
          cat cloudreve/manifest | grep -i version

      - name: 8. ä¸‹è½½å¹¶å®‰è£…fnpackï¼ˆæŒ‡å®šåœ°å€ï¼‰
        if: steps.compare.outputs.need_update == 'true'
        run: |
          FNPACK_URL="https://static2.fnnas.com/fnpack/fnpack-1.0.4-linux-amd64"
          curl -SL --retry 3 --connect-timeout 10 -o /usr/local/bin/fnpack "$FNPACK_URL"
          chmod +x /usr/local/bin/fnpack
          
          if ! command -v fnpack &>/dev/null; then
            echo "âŒ fnpackå®‰è£…å¤±è´¥"
            exit 1
          fi
          echo "âœ… fnpackå®‰è£…å®Œæˆï¼š$(which fnpack)"

      - name: 9. æ‰§è¡Œfnpackæ‰“åŒ…
        if: steps.compare.outputs.need_update == 'true'
        run: |
          cd cloudreve
          echo "ğŸ“‹ æ‰“åŒ…ç›®å½•ç»“æ„ï¼š"
          ls -lh app/bin/
          echo "ğŸš€ æ‰§è¡Œæ‰“åŒ…å‘½ä»¤ï¼šfnpack build --directory app"
          fnpack build --directory app
          echo "âœ… fnpackæ‰“åŒ…å®Œæˆ"

      # ===================== å¯é€‰ï¼šä¸Šä¼ æ‰“åŒ…äº§ç‰© =====================
      - name: 10. ä¸Šä¼ æ‰“åŒ…äº§ç‰©
        if: steps.compare.outputs.need_update == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: cloudreve-build-${{ steps.remote_ver.outputs.remote_version }}
          path: cloudreve/
          retention-days: 7
