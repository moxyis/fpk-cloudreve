name: ç‰ˆæœ¬æ¯”å¯¹åè‡ªåŠ¨æ‰“åŒ…Cloudreveå¹¶æ›´æ–°ä»“åº“

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆæ–°å¢è°ƒè¯•å‚æ•°ï¼‰
    inputs:
      debug_mode:
        description: 'æ˜¯å¦å¼€å¯è°ƒè¯•æ¨¡å¼ï¼ˆtrue=ä¸æ¨é€ï¼Œä»…æ‰§è¡Œæ‰“åŒ…ï¼›false=æ­£å¸¸æ¨é€ï¼‰'
        required: true
        default: 'false'
        type: boolean
  schedule:
    - cron: '0 0 * * *'  

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æˆäºˆå†™å…¥ä»“åº“/åˆ›å»ºReleaseæƒé™
      pull-requests: read
    steps:
      # ===================== ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡ =====================
      - name: 1. æ£€å‡ºå½“å‰ä»“åº“ä»£ç ï¼ˆå¸¦å®Œæ•´å†å²ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´æ£€å‡ºå†å²
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. é…ç½®Gitå…¨å±€èº«ä»½ï¼ˆè·¨ä»“åº“æ¨é€é€šç”¨ï¼‰
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # è¾“å‡ºè°ƒè¯•æ¨¡å¼çŠ¶æ€
          echo "ğŸ” è°ƒè¯•æ¨¡å¼ï¼š${{ github.event.inputs.debug_mode || 'false' }}"
          echo "debug_mode=${{ github.event.inputs.debug_mode || 'false' }}" >> $GITHUB_ENV

      - name: 3. å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆjq/curl/sedï¼‰
        run: |
          sudo apt update && sudo apt install -y jq curl sed
          echo "åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆ"

      # ===================== ç¬¬äºŒæ­¥ï¼šç‰ˆæœ¬æ¯”å¯¹ï¼ˆæ ¸å¿ƒå‰ç½®ï¼‰ =====================
      - name: 4. è¯»å–æœ¬åœ°manifestç‰ˆæœ¬å·ï¼ˆä»…ç‰ˆæœ¬ï¼Œplatformç”±å„æ¶æ„äº§ç‰©å£°æ˜ï¼‰
        id: local_ver
        run: |
          MANIFEST_FILE="Cloudreve/manifest"
          # ä»…è¯»å–ç‰ˆæœ¬å·ï¼ˆplatformä¸å‚ä¸ä¸»manifestçš„ç‰ˆæœ¬æ¯”å¯¹ï¼‰
          if [ -f "$MANIFEST_FILE" ]; then
            LOCAL_VERSION=$(sed -n 's/^[[:space:]]*version[[:space:]]*[:=][[:space:]]*//p' "$MANIFEST_FILE" \
              | tr -d '"' | tr -d "'" | sed 's/^v//' | xargs)
            echo "æœ¬åœ°manifestç‰ˆæœ¬ï¼š$LOCAL_VERSION"
            echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT
          else
            echo "âŒ æœªæ‰¾åˆ°Cloudreve/manifestï¼Œå¼ºåˆ¶è§¦å‘æ›´æ–°"
            echo "local_version=0.0.0" >> $GITHUB_OUTPUT
            mkdir -p Cloudreve
            # åˆå§‹åŒ–ä¸»manifestï¼ˆä»…ç‰ˆæœ¬ï¼Œæ— platformï¼‰
            echo "version: 0.0.0" > "$MANIFEST_FILE"
            # è°ƒè¯•æ¨¡å¼ï¼šä»…æ‰“å°ï¼Œä¸æäº¤
            if [ "$DEBUG_MODE" = "false" ]; then
              git add "$MANIFEST_FILE"
              git commit -m "chore: åˆå§‹åŒ–manifestæ–‡ä»¶ï¼ˆä»…ç‰ˆæœ¬å­—æ®µï¼‰" || echo "æ— éœ€è¦æäº¤çš„å˜æ›´"
            else
              echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡manifeståˆå§‹åŒ–æäº¤"
            fi
          fi
        env:
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}

      - name: 5. è·å–Cloudreveå®˜æ–¹æœ€æ–°æ­£å¼ç‰ˆç‰ˆæœ¬å· + æ¶æ„æ˜ å°„
        id: remote_ver
        run: |
          REMOTE_VERSION=$(curl -sSL --retry 3 --connect-timeout 10 \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/cloudreve/Cloudreve/releases/latest" \
            | jq -r '.tag_name' | sed 's/^v//' | xargs)
          
          if [ -z "$REMOTE_VERSION" ] || [ "$REMOTE_VERSION" = "null" ]; then
            echo "âŒ è·å–è¿œç¨‹ç‰ˆæœ¬å¤±è´¥"
            exit 1
          fi
          
          echo "è¿œç¨‹æœ€æ–°ç‰ˆæœ¬ï¼š$REMOTE_VERSION"
          echo "remote_version=$REMOTE_VERSION" >> $GITHUB_OUTPUT
          # å®šä¹‰æ¶æ„æ˜ å°„ï¼ˆå®˜æ–¹æ¶æ„ -> platformå­—æ®µå€¼ï¼‰ï¼Œå•å€¼å£°æ˜
          echo "arch_mapping=Linux-AMD64:x86,Linux-ARM64:arm" >> $GITHUB_OUTPUT

      - name: 6. ç‰ˆæœ¬æ¯”å¯¹ï¼Œåˆ¤æ–­æ˜¯å¦æ›´æ–°
        id: compare
        run: |
          if [ "${{ steps.local_ver.outputs.local_version }}" = "${{ steps.remote_ver.outputs.remote_version }}" ]; then
            echo "âœ… æœ¬åœ°ç‰ˆæœ¬ä¸è¿œç¨‹ç‰ˆæœ¬ä¸€è‡´ï¼ˆ${{ steps.remote_ver.outputs.remote_version }}ï¼‰ï¼Œæ— éœ€æ›´æ–°"
            echo "need_update=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå¼€å§‹æ›´æ–°æ‰“åŒ…æµç¨‹"
            echo "need_update=true" >> $GITHUB_OUTPUT
          fi

      # ===================== ç¬¬ä¸‰æ­¥ï¼šä»…ç‰ˆæœ¬ä¸ä¸€è‡´æ—¶æ‰§è¡Œï¼ˆå¤šæ¶æ„å¾ªç¯å¤„ç†ï¼‰ =====================
      - name: 7. ä¸‹è½½å¹¶å®‰è£…fnpackï¼ˆæŒ‡å®šåœ°å€ï¼‰
        if: steps.compare.outputs.need_update == 'true'
        run: |
          FNPACK_URL="https://static2.fnnas.com/fnpack/fnpack-1.0.4-linux-amd64"
          curl -SL --retry 3 --connect-timeout 10 -o /usr/local/bin/fnpack "$FNPACK_URL"
          chmod +x /usr/local/bin/fnpack
          
          if ! command -v fnpack &>/dev/null; then
            echo "âŒ fnpackå®‰è£…å¤±è´¥"
            exit 1
          fi
          echo "âœ… fnpackå®‰è£…å®Œæˆï¼š$(which fnpack)"

      - name: 8. å¾ªç¯å¤„ç†å¤šæ¶æ„æ‰“åŒ…ï¼ˆæ ¸å¿ƒï¼šæ¯ä¸ªæ¶æ„è®¾ç½®ç‹¬ç«‹platformå­—æ®µï¼‰
        if: steps.compare.outputs.need_update == 'true'
        id: build_multi_arch
        run: |
          set -euo pipefail
          # è§£ææ¶æ„æ˜ å°„ï¼ˆæ ¼å¼ï¼šå®˜æ–¹æ¶æ„:platformå€¼,å®˜æ–¹æ¶æ„:platformå€¼ï¼‰
          IFS=',' read -ra ARCH_MAP_LIST <<< "${{ steps.remote_ver.outputs.arch_mapping }}"
          REMOTE_VERSION="${{ steps.remote_ver.outputs.remote_version }}"
          
          # åˆå§‹åŒ–å˜é‡ï¼Œå­˜å‚¨æ‰€æœ‰æ‰“åŒ…åçš„æ–‡ä»¶è·¯å¾„ï¼ˆç”¨äºReleaseä¸Šä¼ ï¼‰
          RELEASE_FILES=""
          # å­˜å‚¨FnDepotéœ€è¦çš„æ–‡ä»¶è·¯å¾„ï¼ˆæŒ‰æ¶æ„åˆ†ç›®å½•ï¼‰
          FNDEPOT_FPK_PATHS=""

          # å¾ªç¯å¤„ç†æ¯ä¸ªæ¶æ„æ˜ å°„
          for ARCH_MAP in "${ARCH_MAP_LIST[@]}"; do
            # æ‹†åˆ†å®˜æ–¹æ¶æ„å’Œplatformå€¼
            IFS=':' read -r OFFICIAL_ARCH PLATFORM_VAL <<< "$ARCH_MAP"
            echo "========================================"
            echo "ğŸš€ å¼€å§‹å¤„ç†æ¶æ„ï¼š$OFFICIAL_ARCH -> platform=$PLATFORM_VAL"
            echo "========================================"
            
            # æ¶æ„å…³é”®è¯æ˜ å°„ï¼ˆç”¨äºä¸‹è½½å®˜æ–¹åŒ…ï¼‰
            case $OFFICIAL_ARCH in
              Linux-AMD64)
                ARCH_KEY="linux_amd64"
                ARCH_SHORT="amd64"
                ;;
              Linux-ARM64)
                ARCH_KEY="linux_arm64"
                ARCH_SHORT="arm64"
                ;;
              *)
                echo "âŒ ä¸æ”¯æŒçš„æ¶æ„ï¼š$OFFICIAL_ARCH"
                exit 1
                ;;
            esac
            
            # 1. è·å–å¯¹åº”æ¶æ„çš„ä¸‹è½½é“¾æ¥
            RELEASE_DATA=$(curl -sSL --retry 3 --connect-timeout 10 \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/cloudreve/Cloudreve/releases/latest")
            
            DOWNLOAD_URL=$(echo "$RELEASE_DATA" | jq -r \
              '.assets[] | select(.name | contains("'$ARCH_KEY'.tar.gz")) | .browser_download_url' | head -n1)
            
            if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
              echo "âŒ æœªæ‰¾åˆ° $OFFICIAL_ARCH æ¶æ„çš„èµ„äº§ï¼ˆå…³é”®è¯ï¼š$ARCH_KEY.tar.gzï¼‰"
              exit 1
            fi
            
            MATCHED_ASSET=$(echo "$RELEASE_DATA" | jq -r '.assets[] | select(.name | contains("'$ARCH_KEY'.tar.gz")) | .name' | head -n1)
            echo "âœ… åŒ¹é…åˆ° $OFFICIAL_ARCH æ¶æ„èµ„äº§ï¼š$MATCHED_ASSET"
            echo "âœ… ä¸‹è½½é“¾æ¥ï¼š$DOWNLOAD_URL"
            
            # 2. åˆ›å»ºæ¶æ„ä¸“å±ç›®å½•ï¼Œé¿å…æ–‡ä»¶å†²çª
            ARCH_DIR="Cloudreve_$ARCH_SHORT"
            mkdir -p $ARCH_DIR/app/bin
            curl -SL --retry 3 --connect-timeout 10 -o /tmp/cloudreve_$ARCH_SHORT.tar.gz "$DOWNLOAD_URL"
            
            # 3. è§£å‹å¹¶éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶
            tar -zxf /tmp/cloudreve_$ARCH_SHORT.tar.gz -C /tmp
            if [ ! -f "/tmp/cloudreve" ]; then
              echo "âŒ $OFFICIAL_ARCH æ¶æ„è§£å‹åæœªæ‰¾åˆ°cloudreveäºŒè¿›åˆ¶æ–‡ä»¶"
              exit 1
            fi
            
            # 4. ç§»åŠ¨æ–‡ä»¶+æ·»åŠ æ‰§è¡Œæƒé™
            mv /tmp/cloudreve $ARCH_DIR/app/bin/
            chmod +x $ARCH_DIR/app/bin/cloudreve
            rm -rf /tmp/cloudreve_$ARCH_SHORT.tar.gz /tmp/cloudreve
            
            # 5. ç”Ÿæˆæ¶æ„ä¸“å±manifestï¼ˆæ ¸å¿ƒï¼šæ·»åŠ platformå­—æ®µï¼Œå•å€¼å£°æ˜ï¼‰
            cat > $ARCH_DIR/manifest << EOF
version: $REMOTE_VERSION
platform: $PLATFORM_VAL
EOF
            echo "âœ… ç”Ÿæˆ $ARCH_SHORT æ¶æ„ä¸“å±manifestï¼š"
            cat $ARCH_DIR/manifest
            
            # 6. è¿›å…¥æ¶æ„ç›®å½•æ‰§è¡Œfnpackæ‰“åŒ…
            cd $ARCH_DIR
            echo "ğŸš€ è¿›å…¥ $ARCH_DIR ç›®å½•ï¼Œæ‰§è¡Œæ‰“åŒ…å‘½ä»¤ï¼šfnpack build"
            fnpack build
            
            # 7. æŸ¥æ‰¾æ‰“åŒ…åçš„fpkæ–‡ä»¶
            FPK_FILE=$(find . -name "*.fpk" -type f | head -n1)
            if [ -z "$FPK_FILE" ]; then
              echo "âŒ $OFFICIAL_ARCH æ¶æ„æœªæ‰¾åˆ°æ‰“åŒ…åçš„fpkæ–‡ä»¶"
              exit 1
            fi
            
            # 8. é‡å‘½åæ–‡ä»¶ï¼ˆå¸¦ç‰ˆæœ¬+platformå€¼ï¼‰
            FPK_VERSION_NAME="fpk-cloudreve-v$REMOTE_VERSION-$PLATFORM_VAL.fpk"
            FPK_FULL_PATH="/tmp/$FPK_VERSION_NAME"
            mv $FPK_FILE $FPK_FULL_PATH
            
            # 9. è®°å½•æ–‡ä»¶è·¯å¾„ï¼ˆç”¨äºåç»­ä¸Šä¼ /æ¨é€ï¼‰
            RELEASE_FILES+="$FPK_FULL_PATH "
            # è®°å½•FnDepotè·¯å¾„ï¼ˆæŒ‰æ¶æ„åˆ†ç›®å½•å­˜å‚¨ï¼‰
            FNDEPOT_FPK_PATHS+="$FPK_FULL_PATH:$PLATFORM_VAL "
            
            echo "âœ… $OFFICIAL_ARCH æ¶æ„æ‰“åŒ…å®Œæˆï¼š$FPK_FULL_PATHï¼ˆplatform=$PLATFORM_VALï¼‰"
            cd -
          done
          
          # è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "release_files=$RELEASE_FILES" >> $GITHUB_OUTPUT
          echo "fndepot_fpk_paths=$FNDEPOT_FPK_PATHS" >> $GITHUB_OUTPUT
          echo "âœ… æ‰€æœ‰æ¶æ„æ‰“åŒ…å®Œæˆï¼ŒReleaseæ–‡ä»¶åˆ—è¡¨ï¼š$RELEASE_FILES"

      - name: 9. æ›´æ–°ä¸»manifestçš„ç‰ˆæœ¬å­—æ®µ
        if: steps.compare.outputs.need_update == 'true'
        run: |
          MANIFEST_FILE="Cloudreve/manifest"
          # ä»…æ›´æ–°ç‰ˆæœ¬å·ï¼ˆplatformç”±å„æ¶æ„äº§ç‰©çš„manifestå£°æ˜ï¼‰
          sed -i -E \
            "s/(^[[:space:]]*version[[:space:]]*[:=][[:space:]]*)([\"']?)([0-9a-zA-Z.]+)([\"']?)/\1\2${{ steps.remote_ver.outputs.remote_version }}\4/" \
            "$MANIFEST_FILE"
          
          echo "âœ… ä¸»manifestç‰ˆæœ¬å·²æ›´æ–°ä¸ºï¼š${{ steps.remote_ver.outputs.remote_version }}"
          cat "$MANIFEST_FILE" | grep -i version

          # æš‚å­˜å˜æ›´ï¼ˆè°ƒè¯•æ¨¡å¼ä»…æš‚å­˜ï¼Œä¸æäº¤ï¼‰
          git add "$MANIFEST_FILE"

      - name: 10. æäº¤å¹¶æ¨é€manifestå˜æ›´åˆ°å½“å‰ä»“åº“ï¼ˆè°ƒè¯•æ¨¡å¼è·³è¿‡ï¼‰
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode != 'true'
        run: |
          git commit -m "chore: æ›´æ–°Cloudreveç‰ˆæœ¬è‡³${{ steps.remote_ver.outputs.remote_version }}" || echo "âœ… æ— éœ€è¦æäº¤çš„manifestå˜æ›´"
          git push origin HEAD:${{ github.ref_name }}
          echo "âœ… ä¸»manifestç‰ˆæœ¬å·å·²æ¨é€åˆ°å½“å‰ä»“åº“"

      - name: 10.1 è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡manifestæ¨é€
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode == 'true'
        run: |
          echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡manifestæäº¤å’Œæ¨é€"

      # ===================== ç¬¬å››æ­¥ï¼šæ¨é€å¤šæ¶æ„fpkåˆ°FnDepotä»“åº“ï¼ˆè°ƒè¯•æ¨¡å¼è·³è¿‡ï¼‰ =====================
      - name: 11. å…‹éš†FnDepotä»“åº“ï¼ˆç›®æ ‡ä»“åº“ï¼Œè°ƒè¯•æ¨¡å¼è·³è¿‡ï¼‰
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode != 'true'
        run: |
          # ä½¿ç”¨PATä»¤ç‰Œå…‹éš†ï¼ˆéœ€åœ¨å½“å‰ä»“åº“Secretsé…ç½® FnDepot_PATï¼‰
          git clone https://${{ secrets.FnDepot_PAT }}@github.com/moxyis/FnDepot.git /tmp/FnDepot
          echo "âœ… æˆåŠŸå…‹éš†FnDepotä»“åº“åˆ°/tmp/FnDepot"

      - name: 11.1 è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡FnDepotå…‹éš†
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode == 'true'
        run: |
          echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡FnDepotä»“åº“å…‹éš†"

      - name: 12. å¤åˆ¶å¤šæ¶æ„fpkæ–‡ä»¶åˆ°FnDepotï¼ˆæŒ‰platformåˆ†ç›®å½•ï¼Œè°ƒè¯•æ¨¡å¼è·³è¿‡ï¼‰
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode != 'true'
        run: |
          # è§£æFnDepotæ–‡ä»¶è·¯å¾„æ˜ å°„ï¼ˆæ ¼å¼ï¼šæ–‡ä»¶è·¯å¾„:platformå€¼,æ–‡ä»¶è·¯å¾„:platformå€¼ï¼‰
          IFS=' ' read -ra FPK_PATH_LIST <<< "${{ steps.build_multi_arch.outputs.fndepot_fpk_paths }}"
          
          for FPK_PATH_MAP in "${FPK_PATH_LIST[@]}"; do
            if [ -z "$FPK_PATH_MAP" ]; then continue; fi
            # æ‹†åˆ†æ–‡ä»¶è·¯å¾„å’Œplatformå€¼
            IFS=':' read -r FPK_FILE PLATFORM_VAL <<< "$FPK_PATH_MAP"
            # åˆ›å»ºæ¶æ„ä¸“å±ç›®å½•
            FNDIR="/tmp/FnDepot/fpk-cloudreve/$PLATFORM_VAL"
            mkdir -p "$FNDIR"
            # åˆ é™¤æ—§æ–‡ä»¶
            rm -f "$FNDIR/fpk-cloudreve.fpk"
            # å¤åˆ¶æ–°æ–‡ä»¶ï¼ˆå›ºå®šåç§°ï¼‰
            cp "$FPK_FILE" "$FNDIR/fpk-cloudreve.fpk"
            echo "âœ… å¤åˆ¶ $PLATFORM_VAL æ¶æ„fpkåˆ°ï¼š$FNDIR/fpk-cloudreve.fpk"
            ls -lh "$FNDIR/"
          done

      - name: 12.1 è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡FnDepotæ–‡ä»¶å¤åˆ¶
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode == 'true'
        run: |
          echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡FnDepotæ–‡ä»¶å¤åˆ¶ï¼Œå¾…å¤åˆ¶æ–‡ä»¶åˆ—è¡¨ï¼š${{ steps.build_multi_arch.outputs.fndepot_fpk_paths }}"

      - name: 13. æ›´æ–°FnDepotä»“åº“çš„fnpack.jsonï¼ˆè°ƒè¯•æ¨¡å¼è·³è¿‡ï¼‰
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode != 'true'
        run: |
          cd /tmp/FnDepot
          REMOTE_VERSION="${{ steps.remote_ver.outputs.remote_version }}"
          
          # åˆå§‹åŒ–fnpack.jsonï¼ˆæŒ‰æ¶æ„åˆ†å­—æ®µï¼‰
          if [ ! -f "fnpack.json" ]; then
            echo '{
  "fpk-cloudreve": {
    "version": "",
    "architectures": {
      "x86": "",
      "arm": ""
    }
  }
}' > fnpack.json
            echo "âœ… åˆ›å»ºé»˜è®¤çš„fnpack.jsonæ–‡ä»¶ï¼ˆæŒ‰æ¶æ„åˆ†ç‰ˆæœ¬ï¼‰"
          fi
          
          # æ›´æ–°æ•´ä½“ç‰ˆæœ¬å’Œå„æ¶æ„ç‰ˆæœ¬
          jq --arg ver "$REMOTE_VERSION" \
             '.["fpk-cloudreve"].version = $ver 
             | .["fpk-cloudreve"].architectures.x86 = $ver 
             | .["fpk-cloudreve"].architectures.arm = $ver' \
             fnpack.json > fnpack.tmp && mv fnpack.tmp fnpack.json
          
          echo "âœ… fnpack.jsonæ›´æ–°å®Œæˆï¼Œå½“å‰å†…å®¹ï¼š"
          cat fnpack.json

      - name: 13.1 è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡FnDepotçš„fnpack.jsonæ›´æ–°
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode == 'true'
        run: |
          echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡FnDepotçš„fnpack.jsonæ›´æ–°ï¼Œç›®æ ‡ç‰ˆæœ¬ï¼š${{ steps.remote_ver.outputs.remote_version }}"

      - name: 14. æ›´æ–°FnDepotä»“åº“README.mdï¼ˆè°ƒè¯•æ¨¡å¼è·³è¿‡ï¼‰
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode != 'true'
        run: |
          cd /tmp/FnDepot
          REMOTE_VERSION="${{ steps.remote_ver.outputs.remote_version }}"
          
          # æ£€æŸ¥README.mdæ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºï¼ˆå«platformåˆ—ï¼‰
          if [ ! -f "README.md" ]; then
            echo "# FnDepot
| **åº”ç”¨** | **ç‰ˆæœ¬** | **x86å¹³å°** | **armå¹³å°** | **é“¾æ¥** |
|----------|----------|-------------|-------------|----------|
| **Cloudreve** | $REMOTE_VERSION | âœ… æ”¯æŒ | âœ… æ”¯æŒ | Cloudreve/https://cloudreve.org/ |

Cloudreveè‡ªåŠ¨åŒ–æ‰“åŒ…è¯´æ˜ï¼š
- ç‰ˆæœ¬ï¼šv$REMOTE_VERSION
- platformå­—æ®µè§„åˆ™ï¼šx86=AMD64æ¶æ„ï¼Œarm=ARM64æ¶æ„
- è„šæœ¬è‡ªåŠ¨åŒ–ä»“åº“ï¼šhttps://github.com/moxyis/fpk-cloudreve" > README.md
            echo "âœ… åˆ›å»ºé»˜è®¤çš„README.mdæ–‡ä»¶ï¼ˆå«platformåˆ—ï¼‰"
          else
            # ç²¾å‡†æ›´æ–°ç‰ˆæœ¬å·ï¼ˆplatformæ”¯æŒçŠ¶æ€å›ºå®šï¼‰
            sed -i -E \
              "s/(\|\s*\*\*Cloudreve\*\*\s*\|\s*)[0-9.]+\s*(\|\s*âœ… æ”¯æŒ\s*\|\s*âœ… æ”¯æŒ\s*\|\s*Cloudreve\/https:\/\/cloudreve.org\/\s*\|)/\1$REMOTE_VERSION\2/g" \
              README.md
              
            echo "âœ… README.mdä¸­Cloudreveç‰ˆæœ¬å·²æ›´æ–°ä¸ºï¼š$REMOTE_VERSION"
          fi
          
          # è¾“å‡ºæ›´æ–°åçš„README.mdå…³é”®å†…å®¹
          echo "ğŸ“„ æ›´æ–°åçš„README.mdå…³é”®å†…å®¹ï¼š"
          grep -A 2 -B 1 "Cloudreve" README.md

      - name: 14.1 è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡FnDepotçš„README.mdæ›´æ–°
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode == 'true'
        run: |
          echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡FnDepotçš„README.mdæ›´æ–°ï¼Œç›®æ ‡ç‰ˆæœ¬ï¼š${{ steps.remote_ver.outputs.remote_version }}"

      - name: 15. æäº¤å¹¶æ¨é€æ‰€æœ‰å˜æ›´åˆ°FnDepotä»“åº“ï¼ˆè°ƒè¯•æ¨¡å¼è·³è¿‡ï¼‰
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode != 'true'
        run: |
          cd /tmp/FnDepot
          
          # æš‚å­˜æ‰€æœ‰å˜æ›´ï¼ˆå¤šæ¶æ„fpkæ–‡ä»¶ + fnpack.json + README.mdï¼‰
          git add fpk-cloudreve/ fnpack.json README.md
          
          # æäº¤å˜æ›´ï¼ˆå¤‡æ³¨ç‰ˆæœ¬+platformæ˜ å°„ï¼‰
          git commit -m "chore: æ›´æ–°Cloudreveç‰ˆæœ¬è‡³${{ steps.remote_ver.outputs.remote_version }}ï¼ˆplatformï¼šx86=AMD64ï¼Œarm=ARM64ï¼‰" || echo "âœ… æ— éœ€è¦æäº¤çš„å˜æ›´"
          
          # æ¨é€å˜æ›´åˆ°FnDepotä»“åº“mainåˆ†æ”¯
          git push origin main
          echo "âœ… æ‰€æœ‰å˜æ›´å·²æ¨é€åˆ° https://github.com/moxyis/FnDepot/tree/main/fpk-cloudreve"

      - name: 15.1 è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡FnDepotæäº¤å’Œæ¨é€
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode == 'true'
        run: |
          echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡FnDepotä»“åº“çš„æäº¤å’Œæ¨é€"

      # ===================== ä¸Šä¼ å¤šæ¶æ„FPKåˆ°GitHub Releasesï¼ˆè°ƒè¯•æ¨¡å¼è·³è¿‡ï¼‰ =====================
      - name: 16. åˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ å¤šæ¶æ„FPKæ–‡ä»¶ï¼ˆè°ƒè¯•æ¨¡å¼è·³è¿‡ï¼‰
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode != 'true'
        uses: softprops/action-gh-release@v2
        with:
          # Releaseæ ‡ç­¾ï¼ˆå¸¦ç‰ˆæœ¬å·ï¼‰
          tag_name: "cloudreve-v${{ steps.remote_ver.outputs.remote_version }}"
          # Releaseæ ‡é¢˜ï¼ˆå¸¦ç‰ˆæœ¬å·ï¼‰
          name: "Cloudreve v${{ steps.remote_ver.outputs.remote_version }}"
          # Releaseæè¿°ï¼ˆæ˜ç¡®platformæ˜ å°„ï¼‰
          body: |
            ## Cloudreve è‡ªåŠ¨æ‰“åŒ…æ›´æ–°
            - ç‰ˆæœ¬ï¼šv${{ steps.remote_ver.outputs.remote_version }}
            - platformå­—æ®µæ˜ å°„ï¼š
              - x86 â†’ Linux-AMD64 æ¶æ„
              - arm â†’ Linux-ARM64 æ¶æ„
            - æ‰“åŒ…æ ¼å¼ï¼šfpk
            - æ›´æ–°æ—¶é—´ï¼š${{ github.run_at }}
            - æ‰“åŒ…å·¥å…·ï¼šfnpack 1.0.4
            - FnDepotä»“åº“ï¼šhttps://github.com/moxyis/FnDepot/tree/main/fpk-cloudreve
          # æ˜¯å¦ä¸ºé¢„å‘å¸ƒ
          prerelease: false
          # ä¸Šä¼ æ‰€æœ‰æ¶æ„çš„fpkæ–‡ä»¶
          files: ${{ steps.build_multi_arch.outputs.release_files }}
          # è¦†ç›–åŒåæ ‡ç­¾
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 16.1 è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡GitHub Releaseåˆ›å»º
        if: steps.compare.outputs.need_update == 'true' && github.event.inputs.debug_mode == 'true'
        run: |
          echo "âš ï¸ è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡GitHub Releaseåˆ›å»ºï¼Œå¾…ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨ï¼š${{ steps.build_multi_arch.outputs.release_files }}"
